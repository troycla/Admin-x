class CaveWindow extends TabbedPopupWindow{layerName="caveWindow";domElementId="CAVESYSTEMD";context=CAVESYSTEM;frameWidthFraction=.0325;frameHeightFraction=.0425;frameRightShadowFraction=.01;frameBottomShadowFraction=.05;caveSystem;caveNode;caveHolderScroller;cachedCaveBackground;colorPalette;tipDisplay;displayedTip="";nodeWidth=25;selectedPath;constructor(e,t){super(e),e||this.setBoundingBox(),this.initializeTabs([]),this.caveSystem=getCaveAtDepth(t),this.initializeCaveDisplay(),this.initializeTipDisplay(),this.initializeDroneList(),this.initializeDroneMenu(),this.setColorPalette(),"undefined"!=typeof eventCaveFrame?this.popupFrameImage=eventCaveFrame:0==worldAtDepth(t).index?this.popupFrameImage=caveFrame:1==worldAtDepth(t).index&&(this.popupFrameImage=moonCaveFrame)}open(){super.open(),hasSeenCaveTutorial||this.startCaveTutorial()}close(){return dialogueManager.compareDialogueId("caveTutorial")&&dialogueManager.hide(),super.close()}render(){this.caveSystem.isActive||closeUi(this),this.selectedPath&&!this.droneMenu.isVisible()&&(this.caveNode=null,this.selectedPath=null),this.context.save(),this.context.clearRect(0,0,this.boundingBox.width,this.boundingBox.height),this.context.restore(),super.render(),this.caveHolderScroller.renderChildren(),this.droneListPane.isVisible()&&this.renderDroneList(),this.droneMenu.isVisible()&&(this.context.save(),this.context.imageSmoothingEnabled=!1,this.droneMenu.render(),this.context.restore())}onTabChange(){this.droneMenu.hide()}initializeCaveDisplay(){this.caveHolderScroller=new HorizontalScrollbox(2*this.bodyContainer.boundingBox.width,.7*this.bodyContainer.boundingBox.height-15,this.context,this.bodyContainer.boundingBox.x,this.bodyContainer.boundingBox.y,this.bodyContainer.boundingBox.width,.7*this.bodyContainer.boundingBox.height,15),this.caveHolderScroller.isUsingOptimizedRerender=!0,this.caveHolderScroller.context.imageSmoothingEnabled=!1,this.caveHolderScroller.id="CaveHolderScroller",this.caveHolderScroller.contentWidth=Math.max(2*this.bodyContainer.boundingBox.width*(this.caveSystem.caveTreeDepth/25),this.bodyContainer.boundingBox.width),this.caveHolderScroller.initializeScrollbar();for(var e=new Hitbox({x:0,y:0,width:this.caveHolderScroller.contentWidth,height:.7*this.bodyContainer.boundingBox.height},{},"","caveHolder"),t=this.caveSystem.getAllChildNodesFromRoot(),i=0;i<t.length;i++){var n=e.boundingBox.width-this.nodeWidth,o=e.boundingBox.height-this.nodeWidth,r=new Hitbox({x:t[i].x*n,y:t[i].y*o,width:this.nodeWidth,height:this.nodeWidth},{},"pointer","caveNode_"+t[i].id);r.caveWindow=this,r.node=t[i],r.onmouseenter=function(e){if(this.node.isRevealed){var t=e.caveSystem.getRewardsOnNode(this.node),i=this.node.description;t.length>0&&(i.length>0&&(i+="<br>"),i+=_("Treasure:")+e.getRewardsListFromArray(t,"<br> - ",!0)),showTooltip(this.node.name,i,mouseX,mouseY,180)}else{i=_("Explore deeper in the cave to reveal this node");showTooltip("???",i,mouseX,mouseY,180)}}.bind(r,this),r.onmouseexit=function(){hideTooltip()},r.onmousedown=function(){this.caveWindow.caveNode=this.node,this.caveWindow.selectedPath=this.caveWindow.caveSystem.getPathToNode(this.node);var e=this.getRelativeCoordinates(0,0,this.caveWindow);this.caveWindow.droneMenu.selectedBlueprint=null,this.caveWindow.droneMenu.show(e.x+this.boundingBox.width,e.y+this.boundingBox.height),mutebuttons||clickAudio[rand(0,clickAudio.length-1)].play(),hideTooltip(),this.caveWindow.isTutorialAtStep("selectNode")?dialogueManager.next("caveTutorial"):this.caveWindow.isTutorialAtStep("sendDrone")&&dialogueManager.next("dronesExplanation")},r.render=function(e){var t=this.caveWindow.caveHolderScroller.context,i=this.getRelativeCoordinates(0,0,this.parent),r=this.caveWindow.caveSystem.getRewardsOnNode(this.node),a=this.node.getIcon();if(t.save(),this.node.isRevealed){t.fillStyle=this.caveWindow.colorPalette.revealed,t.beginPath(),t.arc(i.x+this.boundingBox.width/2,i.y+this.boundingBox.height/2,5,0,2*Math.PI),t.fill(),this.node.affectingDrone&&this.node.affectingDrone.isAlive&&(e.caveHolderScroller.context.lineWidth=5,e.caveHolderScroller.context.strokeStyle=this.node.effectColor,e.caveHolderScroller.context.globalAlpha=.1+.15*oscillate(numFramesRendered,24),e.caveHolderScroller.context.stroke(),e.caveHolderScroller.context.globalAlpha=1),a&&drawImageFitInBox(t,a,i.x+.05*this.boundingBox.width,i.y+.05*this.boundingBox.height,this.boundingBox.width,this.boundingBox.height);for(var d=r.length-1;d>=0;--d)if(r[d].distanceFromNode>0&&r[d].isClaimed){var h=this.node.parent,s=this.node,l=h.y;null!=h.parent&&(l=h.parent.y);var c=h.x,g=h.y,u=s.x,x=s.y,v=x-g,b=l-g,y=h.x+.25/e.caveSystem.caveTreeDepth,m=g-.25*b,p=h.x+.75/e.caveSystem.caveTreeDepth,B=x-.25*v,f=getBezierXY(r[d].distanceFromNode,c*n,g*o,y*n,m*o,p*n,B*o,u*n,x*o);drawImageFitInBox(t,r[0].icon,f.x+.05*this.boundingBox.width,f.y+.05*this.boundingBox.height,this.boundingBox.width,this.boundingBox.height),r.splice(d,1)}r.length>0&&(drawImageFitInBox(t,r[0].icon,i.x+.05*this.boundingBox.width,i.y+.05*this.boundingBox.height,this.boundingBox.width,this.boundingBox.height),r.length>1&&(t.font="24px KanitB",t.fillStyle="#5EB65D",t.strokeStyle="#000000",t.lineWidth=2,t.textBaseline="middle",t.strokeText("+",i.x+this.boundingBox.width-8,i.y+this.boundingBox.height-4),t.fillText("+",i.x+this.boundingBox.width-8,i.y+this.boundingBox.height-4)))}else{var F=.6*this.boundingBox.width;drawImageFitInBox(t,e.colorPalette.questionMark,i.x+(this.boundingBox.width-F)/2+.05*this.boundingBox.width,i.y+(this.boundingBox.height-F)/2+.05*this.boundingBox.height,F,F)}t.restore(),this.renderChildren()}.bind(r,this),r.isEnabled=()=>!this.isTutorialActive||!this.isTutorialAtStep(["caveIntro1","caveIntro2"]),e.addHitbox(r);var a=new EasyHintHighlight;a.isVisible=function(e,t){if(e.droneMenu.isVisible()){if(t==e.caveNode)return this.highlightColor="#E37476",!0}else if(this.highlightColor="#76E374",e.isTutorialAtStep("selectNode")&&t.depth>0)return this.highlightColor="#FEFF37",!0;return!1}.bind(a,this,r.node),a.root=e,a.rootContext=this.caveHolderScroller.context,a.isCircle=!0,a.sizeReduction=4,r.addHitbox(a),0==r.node.children.length||r.node.isRevealed&&this.caveSystem.getRewardsOnNode(r.node).length}e.isFirstPass=!0,e.render=function(e){var t=e.caveHolderScroller.context;if(t.save(),this.isFirstPass){if(t.save(),e.caveSystem.kmDepth<=1e3)var i=caveBgLight,n=caveBgDark;else i=moonCaveBgLight,n=moonCaveBgDark;t.lineWidth=25,t.strokeStyle="#000000",t.lineCap="round",this.renderTree(e.caveSystem.rootNode,e),t.globalCompositeOperation="source-atop",drawTiledImage(t,n,0,0,this.boundingBox.width,this.boundingBox.height,n.width/2,n.height/2),t.globalCompositeOperation="source-over",t.shadowColor=e.colorPalette.tunnelEdge,t.shadowBlur=4,t.drawImage(t.canvas,0,0),t.shadowBlur=0,t.globalCompositeOperation="destination-over",drawTiledImage(t,i,0,0,this.boundingBox.width,this.boundingBox.height,this.boundingBox.height,this.boundingBox.height),this.cachedCaveBackground=new Image,this.cachedCaveBackground.src=t.canvas.toDataURL(),t.restore()}else t.drawImage(this.cachedCaveBackground,0,0);t.fillStyle=e.colorPalette.revealed,t.strokeStyle=e.colorPalette.revealed,t.lineWidth=1,this.renderTree(e.caveSystem.rootNode,e),this.renderChildren(),t.fillStyle="#00FF00",this.renderDrones(e),t.restore(),this.isFirstPass=!1}.bind(e,this),e.renderTree=function(e,t){for(var i=t.nodeWidth/2,n=t.nodeWidth/2,o=this.boundingBox.height-t.nodeWidth,r=this.boundingBox.width-t.nodeWidth,a=0;a<e.children.length;a++){t.caveHolderScroller.context.save();var d=e.children[a];t.caveHolderScroller.context.strokeStyle=d.isRevealed?t.colorPalette.revealed:t.colorPalette.hidden;var h=e.y;null!=e.parent&&(h=e.parent.y);var s=e.x,l=e.y,c=d.x,g=d.y,u=g-l,x=h-l,v=e.x+.25/t.caveSystem.caveTreeDepth,b=l-.25*x,y=e.x+.75/t.caveSystem.caveTreeDepth,m=g-.25*u;if(t.caveHolderScroller.context.beginPath(),t.caveHolderScroller.context.moveTo(i+s*r,n+l*o),t.caveHolderScroller.context.bezierCurveTo(i+v*r,n+b*o,i+y*r,n+m*o,i+c*r,n+g*o),null!=t.caveNode&&0==t.caveNode.id.indexOf(d.id)&&t.droneMenu.isVisible()){var p=-3*e.depth;t.caveHolderScroller.context.strokeStyle=rgbToHex(80+175*oscillate(numFramesRendered+p,12),90,90)}else if(null!=t.highlightedDrone){var B=t.highlightedDrone.nodePath[t.highlightedDrone.lastReachedNodeIndex];if(0==t.highlightedDrone.nodePath[t.highlightedDrone.nodePath.length-1].id.indexOf(d.id)&&(t.highlightedDrone.isMovingForward&&e.depth>=B.depth||!t.highlightedDrone.isMovingForward&&e.depth<B.depth)){p=t.highlightedDrone.isMovingForward?-3*e.depth:3*e.depth;t.caveHolderScroller.context.strokeStyle=rgbToHex(70,55+200*oscillate(numFramesRendered+p,12),70)}}t.caveHolderScroller.context.stroke(),e.affectingDrone&&e.affectingDrone.isAlive&&d.affectingDrone&&d.affectingDrone.isAlive&&e.effectColor==d.effectColor&&(t.caveHolderScroller.context.lineWidth=5,t.caveHolderScroller.context.strokeStyle=e.effectColor,t.caveHolderScroller.context.globalAlpha=.1+.2*oscillate(numFramesRendered,24),t.caveHolderScroller.context.stroke()),t.caveHolderScroller.context.restore(),this.renderTree(d,t)}},e.renderDrones=function(e){try{for(var t=e.caveHolderScroller.context,i={x:e.nodeWidth/2,y:e.nodeWidth/2},n=this.boundingBox.height-e.nodeWidth,o=this.boundingBox.width-e.nodeWidth,r=0;r<e.caveSystem.activeDrones.length;r++){var a=e.caveSystem.activeDrones[r];a.logStatus=!1;var d=a.nodePath[a.lastReachedNodeIndex],h=a.nodePath[a.lastReachedNodeIndex],s=a.progressToNextNode;a.isMovingForward?a.nodePath.length>1&&a.nodePath.length>a.lastReachedNodeIndex&&(h=a.nodePath[a.nextNodeIndex()]):(d=a.nodePath[a.nextNodeIndex()],s=1-a.progressToNextNode);var l=d.y;null!=d.parent&&(l=d.parent.y);var c=d.x,g=d.y,u=h.x,x=h.y,v=x-g,b=l-g,y=d.x+.25/e.caveSystem.caveTreeDepth,m=g-.25*b,p=d.x+.75/e.caveSystem.caveTreeDepth,B=x-.25*v,f=getBezierXY(s,i.x+c*o,i.y+g*n,i.x+y*o,i.y+m*n,i.x+p*o,i.y+B*n,i.x+u*o,i.y+x*n);getBezierAngle(s,i.x+c*o,i.y+g*n,i.x+y*o,i.y+m*n,i.x+p*o,i.y+B*n,i.x+u*o,i.y+x*n);t.save(),e.renderAnimatedDrone(t,a,f.x-10,f.y-10,20,20),t.fillStyle="#000000",t.fillRect(f.x-11,f.y+10,20,4),t.fillStyle="#FF0000",t.fillRect(f.x-10,f.y+11,a.currentHealth/a.totalHealth*18,2),t.fillStyle="#000000",t.fillRect(f.x-11,f.y+14,20,4),t.fillStyle="#00ff00",t.fillRect(f.x-10,f.y+15,a.currentFuel/a.totalFuel*18,2),t.restore()}}catch(e){console.warn("Failed to render drone")}},e.allowBubbling=!0,this.caveHolderScroller.addHitbox(e),this.addHitbox(this.caveHolderScroller)}initializeDroneMenu(){this.droneMenu=new ContextMenu({x:0,y:0,width:.4*this.boundingBox.width,height:.4*this.boundingBox.height}),this.droneMenu.yMax=this.caveHolderScroller.boundingBox.y+this.caveHolderScroller.boundingBox.height,this.addHitbox(this.droneMenu),this.droneMenu.initialize(),this.droneMenu.onHide=function(){this.isTutorialAtStep(["nodeInfoExplanation","dronesExplanation","basicDroneExplanation","magnetDroneExplanation","flyingDroneExplanation","selectDrone","sendDrone"])&&dialogueManager.goToEntryWithKey("selectNode","caveTutorial")}.bind(this);var e=this.droneMenu.bodyContainer,t=getKnownBlueprints();t=filterBlueprintsByCategory(t,craftingCategories.drones);var i,n=Math.min(50,Math.floor(.117*this.boundingBox.height))+12,o=Math.min(t.length,Math.floor((e.boundingBox.width-6)/n)),r=Math.ceil(t.length/o);i=o>1?(e.boundingBox.width-6-n*o)/(o-1):0,i=Math.min(i,10);var a=e.boundingBox.width/2-(o*n+(o-1)*i)/2,d=e.boundingBox.height/2-(r*n+(r-1)*i)/2,h=new Hitbox({x:0,y:d/2-8,width:e.boundingBox.width,height:16},{},"");h.render=function(){var e=this.getRootLayer(),t=this.getRelativeCoordinates(0,0,e);e.context.save(),e.context.font="16px KanitM",e.context.textBaseline="middle",fillTextShrinkToFit(e.context,_("Select a drone to send"),t.x,t.y,this.boundingBox.width,"center"),e.context.restore()},h.isVisible=()=>null==this.droneMenu.selectedBlueprint,e.addHitbox(h);for(var s=0;s<t.length;++s){var l=t[s];if(l){var c=a+s%o*(n+i),g=d+Math.floor(s/o)*(n+i),u=new Hitbox({x:c,y:g,width:n,height:n},{onmousedown:function(e){this.droneMenu.selectedBlueprint=e,this.selectedBlueprint=e,this.droneMenu.selectedDrone=getDroneById(e.craftedItem.item.id),this.discountedIngredients=getIngredientListWithDiscounts(e.ingredients),dialogueManager.next("caveTutorial")}.bind(this,l),onmouseenter:function(e,t,i){var n=this.getGlobalCoordinates(t,i);showTooltip(_(e.craftedItem.item.getName()),_(e.craftedItem.item.getDescription()),n.x*uiScaleX,n.y*uiScaleY)}.bind(e,l,c,g+n),onmouseexit:function(){hideTooltip()}},"pointer");u.render=function(e,t){var i=this.getRelativeCoordinates(0,0,e);e.context.save(),e.context.globalAlpha=.5,e.context.fillStyle="#000000",e.context.fillRect(i.x,i.y,this.boundingBox.width,this.boundingBox.height),e.context.restore(),drawImageFitInBox(e.context,t.craftedItem.item.getIcon(),i.x+6,i.y+6,this.boundingBox.width-12,this.boundingBox.height-12),e.context.drawImage(itemFrame,i.x,i.y,this.boundingBox.width,this.boundingBox.height),this.renderChildren()}.bind(u,this.getRootLayer(),l),u.isVisible=()=>null==this.droneMenu.selectedBlueprint,u.isEnabled=function(e){return!(e>0&&this.isTutorialAtStep("dronesExplanation"))&&null==this.droneMenu.selectedBlueprint}.bind(this,s),e.addHitbox(u,!0);var x=new EasyHintHighlight;x.isVisible=function(e,t){return!(0!=t||!e.isTutorialAtStep("dronesExplanation"))&&(this.highlightColor="#FEFF37",!0)}.bind(x,this,s),u.addHitbox(x),this.initializeDroneCraftingScreen()}}this.droneMenu.hide()}craftDrone(e){if(this.selectedPath){var t=getBlueprintById(craftingCategories.drones,e),i=getDroneById(t.craftedItem.item.id);this.caveSystem.startDroneOnPath(i,this.selectedPath)}}initializeTipDisplay(){this.tipDisplay=new Hitbox({x:0,y:.7*this.bodyContainer.boundingBox.height,width:this.bodyContainer.boundingBox.width,height:.03*this.bodyContainer.boundingBox.height},{},"","tipDisplay"),this.tipDisplay.render=function(e){var t=this.getRelativeCoordinates(0,0,e);if(""==e.displayedTip||0==getAnimationFrameIndex(200,10)){for(var i=caveTips[rand(0,caveTips.length-1)];i==e.displayedTip;)i=caveTips[rand(0,caveTips.length-1)];e.displayedTip=i}e.context.save(),e.context.fillStyle="#FFFFFF",e.context.strokeStyle="#000000",e.context.lineWidth=3,e.context.textBaseline="ideographic",e.context.font="13px Verdana",strokeTextShrinkToFit(e.context,_(e.displayedTip),t.x,t.y+this.boundingBox.height,this.boundingBox.width,"center"),fillTextShrinkToFit(e.context,_(e.displayedTip),t.x,t.y+this.boundingBox.height,this.boundingBox.width,"center")}.bind(this.tipDisplay,this),this.bodyContainer.addHitbox(this.tipDisplay)}initializeDroneList(){this.droneListPane=new Scrollbox(this.bodyContainer.boundingBox.width,0,this.context,this.bodyContainer.boundingBox.x,this.bodyContainer.boundingBox.y+.75*this.bodyContainer.boundingBox.height,this.bodyContainer.boundingBox.width,.26*this.bodyContainer.boundingBox.height,15),this.droneListPane.id="droneListPane",this.droneListPane.allowBubbling=!0,this.droneListPane.context.imageSmoothingEnabled=!0,this.addHitbox(this.droneListPane);var e=new Hitbox({x:0,y:2+.015*this.droneListPane.boundingBox.height,width:.4*this.droneListPane.boundingBox.width,height:.2*this.droneListPane.boundingBox.height},{onmouseenter:function(){var t=this.droneListPane.getGlobalCoordinates(0,e.boundingBox.height);t.x=100*t.x/mainw+"%",t.y=100*t.y/mainh+"%",showUpdatingTooltip(function(){var e=Math.floor(60*(caveMaxFuelStructure.statValueForCurrentLevel()-this.caveSystem.currentFuel)/caveFuelRegenStructure.statValueForCurrentLevel()),t=formattedCountDown(e);return{header:_("Estimated Time Until Full"),body:"<center>"+t+"</center>"}}.bind(this),t.x,t.y,"120px")}.bind(this),onmouseexit:function(){hideTooltip()}},"pointer");this.droneListPane.addHitbox(e);for(var t=0;t<20;++t){var i=new Hitbox({x:0,y:2+.015*this.droneListPane.boundingBox.height+(t+1)*this.droneListPane.boundingBox.height*.2,width:this.droneListPane.boundingBox.width,height:.2*this.droneListPane.boundingBox.height},{onmousedown:function(e){if(e<this.caveSystem.activeDrones.length){var t=this.caveSystem.activeDrones[e],i=(t.nodePath[t.lastReachedNodeIndex].depth/this.caveSystem.caveTreeDepth-this.boundingBox.width/this.caveHolderScroller.contentWidth/2)*this.caveHolderScroller.contentWidth;this.caveHolderScroller.scrollTo(i)}}.bind(this,t),onmouseenter:function(e){e<this.caveSystem.activeDrones.length&&(this.highlightedDrone=this.caveSystem.activeDrones[e])}.bind(this,t),onmouseexit:function(){this.highlightedDrone=null}.bind(this)},"pointer");i.isEnabled=function(e){return e<this.caveSystem.activeDrones.length}.bind(this,t),this.droneListPane.addHitbox(i)}}initializeDroneCraftingScreen(){var e=Math.min(25,Math.ceil(.128*this.boundingBox.height)),t=e/10,i=new Hitbox({x:0,y:0,width:this.droneMenu.bodyContainer.boundingBox.width,height:e+2*t},{},"","blueprintNameBox");i.render=function(i){var n=i.getContext(),o=this.getRelativeCoordinates(0,0,i);n.save(),n.globalAlpha=.6,n.fillStyle="#111111",n.fillRect(o.x,o.y,this.boundingBox.width,this.boundingBox.height),n.globalAlpha=1;var r=Math.min(22,.055*i.boundingBox.height);n.font=r+"px KanitM",n.fillStyle="#FFFFFF",n.textBaseline="top",fillTextWrap(n,i.droneMenu.selectedBlueprint.craftedItem.item.getName(),o.x+e+4*t,o.y+t,this.boundingBox.width-e-5*t,"left",.25),n.restore(),this.renderChildren()}.bind(i,this);var n=new Hitbox({x:t,y:t,width:e,height:e},{},"pointer","blueprintIcon");n.render=function(t){var i=this.getContext(),n=t.droneMenu.selectedBlueprint,o=this.getRelativeCoordinates(0,0,t);if(drawImageFitInBox(i,n.craftedItem.item.getIcon(),o.x,o.y,e,e),1!=n.category&&n.craftedItem.item.getQuantityOwned()>-1){i.fillStyle="#FFFFFF";var r=Math.min(16,.037*this.boundingBox.height);i.font=r+"px Verdana",i.textBaseline="bottom",strokeTextShrinkToFit(t.context,n.craftedItem.item.getCurrentLevel()+1,o.x,o.y+e,this.boundingBox.height,"right"),fillTextShrinkToFit(t.context,n.craftedItem.item.getCurrentLevel()+1,o.x,o.y+e,this.boundingBox.height,"right")}}.bind(n,this),i.addHitbox(n),this.droneMenu.bodyContainer.addHitbox(i),i.isVisible=()=>null!=this.droneMenu.selectedBlueprint,i.isEnabled=()=>null!=this.droneMenu.selectedBlueprint;var o=this.droneMenu.bodyContainer.addHitbox(new Hitbox({x:0,y:i.boundingBox.height,width:this.droneMenu.bodyContainer.boundingBox.width,height:this.droneMenu.bodyContainer.boundingBox.height-i.boundingBox.height},{},""));o.render=function(e){var t=this.getRelativeCoordinates(0,0,e);e.context.save(),e.context.textBaseline="top",e.context.font="14px Verdana",fillTextWrap(e.context,e.selectedBlueprint.craftedItem.item.getDescription(),t.x,t.y,this.boundingBox.width),e.context.restore()}.bind(o,this),o.isVisible=()=>null!=this.droneMenu.selectedBlueprint,o.isEnabled=()=>null!=this.droneMenu.selectedBlueprint;var r=this.droneMenu.bodyContainer.addHitbox(new Button(upgradeb,_("Send Drone"),"14px Verdana","#000000",{x:.3*this.droneMenu.bodyContainer.boundingBox.width,y:.87*this.droneMenu.bodyContainer.boundingBox.height,width:.4*this.droneMenu.bodyContainer.boundingBox.width,height:.12*this.droneMenu.bodyContainer.boundingBox.height},{onmousedown:function(){this.craftDrone(this.selectedBlueprint.craftedItem.item.id),this.caveNode=null,this.selectedPath=null,this.droneMenu.hide(),dialogueManager.next("caveTutorial")}.bind(this)}));r.isVisible=function(e){return null!=e.droneMenu.selectedBlueprint&&(this.image=e.caveSystem.canCraftDrone(e.droneMenu.selectedDrone)?upgradeb:upgradebg_blank,!0)}.bind(r,this),r.isEnabled=()=>null!=this.droneMenu.selectedBlueprint&&this.caveSystem.canCraftDrone(this.droneMenu.selectedDrone);var a=r.addHitbox(new EasyHintHighlight(function(e){return e.isTutorialAtStep("sendDrone")}.bind(r,this)));a.root=this,a.rootContext=this.context,a.sizeReduction=a.lineWidth,a.highlightColor="#FEFF37"}renderAnimatedDrone(e,t,i,n,o,r){e.save(),e.imageSmoothingEnabled=!1;var a=t.spritesheet.width/4,d=getAnimationFrameIndex(4,10);t.isMovingForward||(e.scale(-1,1),i=-(i+o)),t.isTakingDamage&&t.flickerFrames.damage&&d==t.flickerFrames.acting.frameIndex?e.drawImage(t.flickerFrames.damage.image,i,n,o,r):t.isHealing&&t.flickerFrames.healing&&d==t.flickerFrames.healing.frameIndex?e.drawImage(t.flickerFrames.healing.image,i,n,o,r):t.isActing&&t.flickerFrames.acting&&d==t.flickerFrames.acting.frameIndex?e.drawImage(t.flickerFrames.acting.image,i,n,o,r):e.drawImage(t.spritesheet,a*d,0,a,t.spritesheet.height,i,n,o,r),e.restore()}renderDroneList(){this.droneListPane.clearCanvas();var e=this.droneListPane.context,t=.2;e.save(),e.imageSmoothingEnabled=!1;var i=this.droneListPane.boundingBox.height*t,n=.2*this.droneListPane.boundingBox.width,o=.85*i,r=2;renderFancyProgressBar(e,_("Time Remaining: {0}",formattedCountDown(this.caveSystem.remainingSeconds)),this.caveSystem.remainingSeconds/this.caveSystem.totalDuration,this.bodyContainer.boundingBox.width-2*n,r,2*n,i,"#7F7F7F","#000000","#FFFFFF",timerFrame),renderFancyProgressBar(e,_("Fuel: {0}/{1}",Math.floor(this.caveSystem.currentFuel),caveMaxFuelStructure.statValueForCurrentLevel()),this.caveSystem.currentFuel/caveMaxFuelStructure.statValueForCurrentLevel(),0,r+i/2-o/2,2*n,i,"#5EB65D","#000000","#FFFFFF",timerFrame),e.fillStyle="#FFFFFF",e.strokeStyle="#000000",e.textBaseline="bottom",e.lineWidth=3,this.droneListPane.contentHeight=.08*this.droneListPane.boundingBox.height+this.droneListPane.boundingBox.height*t*(1+this.caveSystem.activeDrones.length),e.font="20px Verdana",e.globalAlpha=.3,renderRoundedRectangle(e,0,.07*this.droneListPane.boundingBox.height+o,this.droneListPane.contentWidth,.01*this.droneListPane.boundingBox.height+this.droneListPane.boundingBox.height*t*this.caveSystem.activeDrones.length,2,"#AAAAAA","#111111",1);for(var a=0;a<this.caveSystem.activeDrones.length;a++){var d=this.caveSystem.activeDrones[a];e.globalAlpha=.3,r=this.droneListPane.boundingBox.height*(.07+t*(1+a))-2,a%2==0&&renderRoundedRectangle(e,0,r,this.droneListPane.contentWidth,this.droneListPane.boundingBox.height*t,0,"#AAAAAA","#555555",0),e.globalAlpha=1,this.renderAnimatedDrone(e,d,0,r,i,i);for(var h=0;h<d.rewardCapacity;++h){if(e.globalAlpha=.5,e.fillStyle="#000000",e.fillRect(this.droneListPane.contentWidth-(1.02*h+1)*i,r,i,i),e.globalAlpha=1,h<d.inventory.length){var s=this.caveSystem.rewards[d.inventory[h]];drawImageFitInBox(e,s.icon,this.droneListPane.contentWidth-(1.02*h+1)*i+.05*i,r+.05*i,.9*i,.9*i)}drawImageFitInBox(e,itemFrame,this.droneListPane.contentWidth-(1.02*h+1)*i,r,i,i)}var l,c=.2*this.droneListPane.boundingBox.width,g=.85*i;renderFancyProgressBar(e,_("Health: {0}/{1}",Math.round(d.currentHealth),d.totalHealth),d.currentHealth/d.totalHealth,1.25*i,r+i/2-g/2,c,g,"#c92828","#000000","#FFFFFF",timerFrame),renderFancyProgressBar(e,_("Fuel: {0}/{1}",Math.round(d.currentFuel),d.totalFuel),d.currentFuel/d.totalFuel,1.75*i+c,r+i/2-g/2,c,g,"#5EB65D","#000000","#FFFFFF",timerFrame),l=d.waitAtNodeTime>0?d.nodePath[d.lastReachedNodeIndex].currentHealth&&d.nodePath[d.lastReachedNodeIndex].currentHealth>0?1-d.nodePath[d.lastReachedNodeIndex].currentHealth/d.nodePath[d.lastReachedNodeIndex].totalHealth:1-d.waitAtNodeTime/d.totalWaitTime:d.progressToNextNode,renderFancyProgressBar(e,d.status,l,2.25*i+2*c,r+i/2-g/2,1.5*c,g,"#7F7F7F","#000000","#FFFFFF",timerFrame);d.getEstimatedTimeRemaining()}e.globalAlpha=1,e.restore(),this.droneListPane.renderChildren()}getRewardsListFromArray(e,t,i=!1){var n="";for(var o in i&&(n+=t),e)n+=e[o].getName(),o<e.length-1&&(n+=t);return n}getCaveWorld(){return this.caveSystem.kmDepth<=1e3?EARTH_INDEX:MOON_INDEX}setColorPalette(){var e=this.getCaveWorld();e==EARTH_INDEX?this.colorPalette={revealed:"#80513c",hidden:"#4a372f",tunnelEdge:"#663b36",questionMark:caveIconQuestionMark}:(e==MOON_INDEX||e==TITAN_INDEX)&&(this.colorPalette={revealed:"#5ea0a8",hidden:"#3c6f75",tunnelEdge:"#4f777d",questionMark:caveIconQuestionMarkMoon})}startCaveTutorial(){this.isTutorialActive=!0,dialogueManager.initialize("caveTutorial",{drone:{name:_("Droney"),image:dronePortrait}},[{entryKey:"caveIntro1",speaker:"drone",text:_("Welcome to the caves! You can send drones into the cave to collect rewards like minerals, chests, and more!"),clickToContinue:!0},{entryKey:"selectNode",speaker:"drone",text:_("Tap a cave chamber to get started!"),clickToContinue:!1,position:{y:"70%"}},{entryKey:"dronesExplanation",speaker:"drone",text:_("These are your drones! They all do different things. Let's start with a basic drone!"),clickToContinue:!1,position:{y:"70%"}},{entryKey:"sendDrone",speaker:"drone",text:_("These are the drone stats! Tap the button to send the drone!"),clickToContinue:!1,position:{y:"70%"}},{entryKey:"droneStatusExplanation",speaker:"drone",text:_("Here you can see your drone's health, fuel, progress, and inventory."),clickToContinue:!0,position:{y:"45%"}},{entryKey:"fuelExplanation",speaker:"drone",text:_("This is your total fuel for this cave. Each drone will use some of this fuel when it is sent out."),clickToContinue:!0,position:{x:0,y:"45%"}},{entryKey:"timeExplanation",speaker:"drone",text:_("This is the time you have left to explore the cave. Once the cave collapses, everything in it is gone!"),clickToContinue:!0,position:{x:"55%",y:"45%"}},{entryKey:"droneReturn",speaker:"drone",text:_("When a drone returns, it gives back its remaining fuel and drops off its treasure! You can collect the treasure in the cave building at 45km!"),clickToContinue:!0},{entryKey:"end",speaker:"drone",text:_("Be sure to experiment to learn how to use each drone. You can upgrade your drone stats in the cave building at 45km. Happy mining!"),clickToContinue:!0,onEnd:function(){this.isTutorialActive=!1,hasSeenCaveTutorial=!0}.bind(this)}]),dialogueManager.setOnEndFunction(function(){this.isTutorialActive=!1,hasSeenCaveTutorial=!0}.bind(this)),dialogueManager.show()}isTutorialAtStep(e){return this.isTutorialActive&&dialogueManager.compareEntryKey(e)}}