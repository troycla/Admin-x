const CAVE_UPDATE_DELTA_TIME_SECONDS=.1,CAVE_MINIMUM_LIFETIME_SECONDS=1500,CAVE_SYSTEM_DURATION_PER_NODE_SECONDS=100,MAX_CAVE_SYSTEMS_AT_A_TIME=7,CAVE_BUILDING_DEPTH=45,MIN_CAVE_SYSTEM_SPAWN_DEPTH=46,CAVE_DEPTH_SCALE_EXPONENT=.444,TRAVEL_TIME_BETWEEN_NODES=100;for(var caves=[],treasureStorage=new TreasureStorage,numberOfCavesExplored=0,numCavesCompleted=0,numberOfRewardsCollected=0,hasFirstCaveSpawned=!1,hasCollectedTreasure=!1,hasSeenCaveTutorial=!1,i=0;i<7;i++)caves.push(createCaveSystem(0,0,1)),caves[i].isActive=!1;function minSpawnableCaveDepth(e){return Math.max(46,e/2)}function getActiveCaves(){for(var e=[],a=0;a<caves.length;a++)caves[a].isActive&&e.push(caves[a]);return e}function getCaveAtDepth(e){for(var a=0;a<caves.length;a++)if(caves[a].kmDepth==e)return caves[a];return null}function numActiveCaves(){return getActiveCaves().length}function createCaveSystem(e,a,t){var r=new CaveSystem(e,a,t);return a>0&&(newNews(_("A cave entrance has opened at {0}km!",e)),mutebuttons||caveAppearsAudio.play()),r}function caveUpdate(e,a=!0){if(depth>=46){for(var t=0;t<caves.length;t++){try{caves[t].update(e)}catch(e){console.warn("Cave "+t+" failed to update."),console.warn(e)}caves[t].caveTreeDepth>0&&(!caves[t].isActive||caves[t].remainingSeconds<=0)&&(newNews(_("The cave at {0}km has collapsed",caves[t].kmDepth)),caves[t]=createCaveSystem(0,0,1),caves[t].isActive=!1)}a&&rollForCaveSystemSpawn()}}function rollForCaveSystemSpawn(){var e=Math.min(4,(depth-46)/100),a=getNumSecondsBetweenSpawnsAtCurrentDepth(),t=depth>=46&&!hasFirstCaveSpawned&&!isSimulating;if(t||1==caveRoller.rand(0,Math.floor(a/.1))&&numActiveCaves()<e){var r=minSpawnableCaveDepth(depth),n=caveRoller.rand(r,depth);t&&(n=46),!isClickableAtDepth(n)&&isSpawnableAtDepth(n)&&(t&&(hasFirstCaveSpawned=!0),startCaveAtDepth(n),updateCaveSystemSpawns())}}function getCaveTreeDepthForCaveGameWorldDepth(e){return Math.round(Math.pow(e,.444))}function getMaxNodesPerDepthBasedOnCaveGameWorldDepth(e){var a=getCaveTreeDepthForCaveGameWorldDepth(e);return Math.ceil(Math.sqrt(a))}function startCaveAtDepth(e){for(var a=0;a<caves.length;a++)if(!caves[a].isActive){var t=getCaveTreeDepthForCaveGameWorldDepth(e),r=getMaxNodesPerDepthBasedOnCaveGameWorldDepth(e);return caves[a]=createCaveSystem(e,t,r),caves[a].isActive=!0,void caves.sort(((e,a)=>e.kmDepth<a.kmDepth?-1:1))}console.log("No inactive cave")}function simulateCavesForTime(e){for(var a=0;a<e;){var t=e-a<750,r=t?.1:3;(getActiveCaves().length>0||t)&&caveUpdate(r,t),a+=r}}function spawnTestCaves(){for(var e in caves)caves[e].isActive=!1;for(e=0;getActiveCaves().length<7&&e<100;++e){var a=Math.max(46,depth/2),t=caveRoller.rand(a,depth);!isClickableAtDepth(t)&&isSpawnableAtDepth(t)&&(startCaveAtDepth(t),updateCaveSystemSpawns())}}var cachedSampledCaveDuration={};function getAverageSampledCaveDurationToDepth(e){if(cachedSampledCaveDuration.hasOwnProperty(e))return cachedSampledCaveDuration[e];for(var a=0,t=0,r=minSpawnableCaveDepth(e);r<=e;r++)for(var n=0;n<4;n++){for(var s=r,o=getCaveTreeDepthForCaveGameWorldDepth(s),v=0;v<o;v++){for(var c=getMaxNodesPerDepthBasedOnCaveGameWorldDepth(s),h=1,i=rand(1,c),d=0,l=0;l<h;l++){var p=Math.max(0,i-Math.floor((d-l)/4)),u=0;p>0&&(u=rand(1,p)),t+=u,d+=u}h=d}a++}var C=Math.max(1500,t/a*100);return cachedSampledCaveDuration[e]=C,C}var cachedAtDepth=-1,cachedNumCaves=-1,cachedNumSecs=-1,spawnRateMultiplier=1;function getNumSecondsBetweenSpawnsAtCurrentDepth(){var e=numActiveCaves();if(depth==cachedAtDepth&&cachedNumCaves==e)return cachedNumSecs;var a=0;if(depth<500)a=.323839*Math.log(.109139*depth);else if(depth<600){var t=(depth-500)/100;a=.323839*Math.log(.109139*depth)*(1-t)+.721348*Math.log(.0100794*depth)*t}else a=.721348*Math.log(.0100794*depth);var r=getAverageSampledCaveDurationToDepth(depth),n=e-a;let s=(0==e?.25:n<0?Math.max(.1,2-Math.pow(10*Math.max(Math.abs(n),1),.75)/10):2+2*n)*r*spawnRateMultiplier;return cachedNumSecs=s,cachedAtDepth=depth,cachedNumCaves=e,s}var caveTips=[_("TIP: Use magnetic drones to pull multiple treasures onto a single location"),_("TIP: A magnetic drone won't pull treasure from its own path"),_("TIP: Be careful collecting treasure from hazardous locations"),_("TIP: Any remaining fuel will be regained when a drone returns"),_("TIP: Drones drop their inventory when they die"),_("TIP: Flying drones avoid ground-based obstacles like boulders and lava"),_("TIP: Drones normally take 2 minutes to travel between locations"),_("TIP: There's no cost to send out a drone"),_("TIP: Treasure will be collected when drones return"),_("TIP: Stored treasure can be collected in the cave building"),_("TIP: Drones can be upgraded in the cave building"),_("TIP: Cave fuel can be upgraded in the Structures tab of the craft menu"),_("TIP: Flying drones can see further than other drones"),_("TIP: Magnetic drones can save treasure from hazardous locations"),_("TIP: Boulders can be destroyed by all land based drones")];