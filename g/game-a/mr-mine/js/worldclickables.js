const MINERAL_DEPOSIT_ID=1,ORANGE_FISH_ID=2,CAVE_SYSTEM_ID=3,DEFAULT_CLICKABLE_LIFESPAN_MSEC=36e5,UNSPAWNABLE_DEPTHS=[20,50,225,300,301,302,303,304],MAX_SPAWNED_MINERAL_DEPOSITS=3,MIN_ORANGE_FISH_SPAWN_TIME_SECONDS=86400,MAX_ORANGE_FISH_SPAWN_TIME_SECONDS=172800,MAX_SPAWNED_ORANGE_FISH=1;var secondsSinceOrangeFishSpawn=0,secondsUntilNextOrangeFishSpawn=clickableRoller.rand(86400,172800),orangeFishCollected=0;function clickedGap(e,i){for(var n=currentlyViewedDepth-(5-e),t=0;t<tradeConfig.tradingPosts.length;++t)if(n==tradeConfig.tradingPosts[t].depth&&11==i)return;if(11==i&&(onWorkerClicked(e,6),clickedGap(e,5)),50==n&&1==i&&(0==hasFoundGolem?(hasFoundGolem=1,learnRangeOfBlueprints(1,16,31),startFoundGolemDialogue()):openUi(CraftingWindow)),100==n&&0==chestCollectorChanceStructure.level&&0==chestCollectorStorageStructure.level&&(chestCollectorChanceStructure.level=1,chestCollectorStorageStructure.level=1,learnRangeOfBlueprints(3,8,9),newNews(_("Discovered the Chest Collector!"))),112==n&&2==i&&questManager.getQuest(94).markComplete(),225==n&&1==i&&(0==hasFoundGidget?(hasFoundGidget=1,learnRangeOfBlueprints(1,32,47),startFoundGidgetDialogue()):openUi(CraftingWindow)),1019==n&&isUfoVisible()&&(questManager.getQuest(95).markComplete(),hasFoundUfo=1),1257==n&&1==i&&(learnRangeOfBlueprints(1,79,87),openUi(CraftingWindow)),isClickableAtDepth(n)){var a=getClickableAtDepth(n);a.maxClicks>a.clicks&&i==a.spawnLocation&&clickableData[a.type].onClick(a)}metalDetectorStructure.level>=5&&chestService.chestExistsAtDepth(n)&&!isClickableAtDepth(n)&&chestService.presentChest(n)}var clickableData={};clickableData[1]={name:"Mineral Deposit",onSpawn:onSpawnMineralDeposit,onClick:onClickedMineralDeposit,rollForSpawn:rollForMineralDepositSpawn},clickableData[2]={name:"Orange Fish",onSpawn:onSpawnOrangeFish,onClick:onClickedOrangeFish,rollForSpawn:rollForOrangeFishSpawn},clickableData[3]={name:"Cave System",onSpawn:function(){},onClick:onClickedCaveSystem,rollForSpawn:function(){}};var clickablesSpawned=0,worldClickables=[];function spawnWorldClickables(){for(var e in removeExpiredClickables(),updateCaveSystemSpawns(),clickableData)clickableData[e].rollForSpawn()}function disposeWorldClickable(e){for(var i=worldClickables.length-1;i>=0;i--)if(worldClickables[i].uid==e.uid){if(worldClickables[i].hitbox)activeLayers.WorldLayer.getHitboxById("level_"+worldClickables[i].depth).deleteHitboxWithId(worldClickables[i].hitbox.id);return void worldClickables.splice(i,1)}}function removeClickablesOfType(e){for(var i=worldClickables.length-1;i>=0;i--)worldClickables[i].type==e&&worldClickables.splice(i,1)}function removeExpiredClickables(){for(var e=currentTime(),i=worldClickables.length-1;i>=0;i--)worldClickables[i].expireTime<e&&worldClickables.splice(i,1)}function numClickablesOfType(e){for(var i=0,n=0;n<worldClickables.length;n++)worldClickables[n].type==e&&i++;return i}function isClickableAtDepth(e){for(var i=0;i<worldClickables.length;i++)if(worldClickables[i].depth==e)return!0;return!1}function getClickableAtDepth(e){for(var i=0;i<worldClickables.length;i++)if(worldClickables[i].depth==e)return worldClickables[i];return null}function isSpawnableAtDepth(e){return!isDepthWithoutWorkers(e)}function getMineralDepositType(e){for(var i=levels[e],n=0,t=1,a=0;a<i.length;a++)i[a][1]>n&&(n=i[a][1],t=i[a][0]);return t}function rollForMineralDepositSpawn(){depth>100&&30==clickableRoller.rand(0+STAT.mineralDepositMultiplier(),30)&&numClickablesOfType(1)<3+STAT.additionalMineralDeposits()&&!isCapacityFull()&&onSpawnMineralDeposit()}function onSpawnMineralDeposit(){var e=Math.max(0,depth-100),i=clickableRoller.rand(e,depth);if(!isClickableAtDepth(i)&&isSpawnableAtDepth(i)){var n=getMineralDepositType(i),t=estimatedMineralsPerMinuteAtLevel(i),a=Math.max(10,depth/2),l=clickableRoller.rand(10,a)*t[n],r=valueOfMineralsPerSecond().multiply(60),o=clickableRoller.rand(10,20),c=r.multiply(o).divide(worldResources[n].sellValue),s=bigNumberMin(new BigNumber(5e8),bigNumberMax(new BigNumber(parseInt(l)),new BigNumber(c))).divide(5).toFloat();if(!Number.isNaN(s)){var d=getNewMineralDeposit(++clickablesSpawned,n,s,i,rand(1,9));worldClickables.push(d)}}}function getNewMineralDeposit(e,i,n,t,a){var l={uid:e,type:1,subType:i,valuePerClick:n,depth:t,spawnLocation:a,clicks:0,maxClicks:5,renderAssetFunction:renderMineralDeposit(i),expireTime:currentTime()+36e5,spawnTime:currentTime()};return l.hitbox=createClickableHitbox(l),l}function renderMineralDeposit(e){return function(i,n,t){var a=window["ore"+e+"deposit"],l=currentTime()-t.spawnTime,r=Math.min(1,l/500),o=.045*mainw*r,c=.045*mainw,s=.09*mainh*r,d=.09*mainh;a&&MAIN.drawImage(a,a.width/4*Math.min(t.clicks,3),0,a.width/4,a.height,i+(c-o)/2,n+(d-s),o,s)}}function renderMineralDepositHitbox(e){return function(i){var n=i.hitbox,t=n.getGlobalCoordinates(0,0),a=window["ore"+e+"deposit"],l=currentTime()-i.spawnTime,r=Math.min(1,l/500),o=n.boundingBox.width,c=o*r,s=n.boundingBox.height,d=s*r;MAIN.drawImage(a,a.width/4*Math.min(i.clicks,3),0,a.width/4,a.height,t.x+(o-c)/2,t.y+(s-d),c,d),n.renderChildren()}}function onClickedMineralDeposit(e){e.clicks<e.maxClicks&&(mutebuttons||clickMineral[rand(0,clickMineral.length-1)].play(),e.clicks++,isNaN(e.valuePerClick)?e.clicks=e.maxClicks:(showFloatingText("+"+beautifynum(e.valuePerClick)+"x "+worldResources[e.subType].name,"16px Verdana","#FFFFFF",mouseX/uiScaleX+rand(-10,10),mouseY/uiScaleY-rand(10,25),1200,!0,sinSquared,getFunctionYMovementOnly(easeInPowerFunction(2),-30)),worldResources[e.subType].numOwned+=e.valuePerClick)),e.clicks>=e.maxClicks&&disposeWorldClickable(e)}function rollForOrangeFishSpawn(){depth>51&&secondsSinceOrangeFishSpawn>=secondsUntilNextOrangeFishSpawn&&numClickablesOfType(2)<1&&onSpawnOrangeFish()}function onSpawnOrangeFish(){var e=clickableRoller.rand(51,depth);if(!isClickableAtDepth(e)&&isSpawnableAtDepth(e)){var i=getNewOrangeFishClickable(++clickablesSpawned,e,clickableRoller.rand(1,9));worldClickables.push(i)}}function getNewOrangeFishClickable(e,i,n){var t={uid:e,type:2,depth:i,spawnLocation:n,clicks:0,maxClicks:5,renderAssetFunction:renderOrangeFish(),expireTime:Number.MAX_SAFE_INTEGER,spawnTime:currentTime()};return t.hitbox=createClickableHitbox(t),t}function renderOrangeFish(){return function(e,i,n){MAIN.drawImage(orangeFish,orangeFish.width/4*Math.min(n.clicks,3),0,orangeFish.width/4,orangeFish.height,e,i,.045*mainw,.09*mainh)}}function renderOrangeFishHitbox(){return function(e){var i=e.hitbox,n=i.getGlobalCoordinates(0,0);MAIN.drawImage(orangeFish,orangeFish.width/4*Math.min(e.clicks,3),0,orangeFish.width/4,orangeFish.height,n.x,n.y,i.boundingBox.width,i.boundingBox.height)}}function onClickedOrangeFish(e){if(secondsSinceOrangeFishSpawn=0,secondsUntilNextOrangeFishSpawn=clickableRoller.rand(86400,172800),e.clicks<e.maxClicks){mutebuttons||clickMineral[rand(0,clickMineral.length-1)].play(),e.clicks++;var i="",n=Math.max(.5,depth/200),t=60*n;switch(clickableRoller.rand(0,4)){case 0:var a=valueOfMineralsPerSecond().multiply(60*parseInt(t));addMoney(a),i="$"+beautifynum(a);break;case 1:tickets++,i=_("1x ticket");break;case 2:i=grantMineral(getMineralDepositType(clickableRoller.rand(Math.floor(depth/2),depth)),n);break;case 3:var l=Math.floor(Math.max(1,n));worldResources[BUILDING_MATERIALS_INDEX].numOwned+=l,i=_("{0}x building materials",l);break;case 4:l=Math.floor(Math.max(1,2*n));worldResources[BUILDING_MATERIALS_INDEX].numOwned+=l,i=_("{0}x building materials",l)}showFloatingText("+"+i,"16px Verdana","#FFFFFF",mouseX/uiScaleX+rand(-10,10),mouseY/uiScaleY-rand(10,25),1200,!0,sinSquared,getFunctionYMovementOnly(easeInPowerFunction(2),-30))}e.clicks>=e.maxClicks&&(disposeWorldClickable(e),orangeFishCollected++)}function createClickableHitbox(e){var i=activeLayers.WorldLayer;if(i){var n=i.getHitboxById("level_"+e.depth);if(n){var t=worldConfig.levelClickableWidth*(e.spawnLocation-.5)+worldConfig.levelClickableSpacing*(e.spawnLocation-1),a=new Hitbox({x:t,y:.2*n.boundingBox.height,width:1.3*worldConfig.levelClickableWidth,height:1.3*worldConfig.levelClickableHeight},{onmousedown:function(e){e?clickableData[e.type].onClick(e):this.parent.deleteHitboxWithId(this.id)}.bind(a,e)},"pointer","clickable_"+e.uid);switch(e.type){case 1:a.render=renderMineralDepositHitbox(e.subType).bind(a,e),a.addHitbox(new EasyHintArrow("down",(function(){return numCoalOwned()<30&&0==getEarth().workersHired&&money.lessThan(30)}),-.45));break;case 2:a.render=renderOrangeFishHitbox(e.subType).bind(a,e);break;case 3:a.render=renderCaveSystemHitbox(e.subType).bind(a,e),a.addHitbox(new EasyHintArrow("down",(function(){return 0==numberOfCavesExplored}),-.45))}return n.addHitbox(a),a}}return null}function updateCaveSystemSpawns(){for(var e=getActiveCaves(),i=0;i<e.length;i++)if(null==getClickableAtDepth(e[i].kmDepth)){var n=getNewCaveSystemClickable(++clickablesSpawned,e[i].kmDepth,1+e[i].kmDepth%9);worldClickables.push(n)}for(i=worldClickables.length-1;i>=0;i--)3==worldClickables[i].type&&null==getCaveAtDepth(worldClickables[i].depth)&&disposeWorldClickable(worldClickables[i])}function getNewCaveSystemClickable(e,i,n){var t={uid:e,type:3,depth:i,spawnLocation:n,clicks:0,maxClicks:Number.MAX_SAFE_INTEGER,renderAssetFunction:renderCaveSystem(),expireTime:Number.MAX_SAFE_INTEGER,spawnTime:currentTime()};return t.hitbox=createClickableHitbox(t),t}function renderCaveSystem(){return function(e,i,n){if(null!=getCaveAtDepth(n.depth)){var t=getCaveAtDepth(n.depth).remainingSeconds;if(t>0){var a=earthCave1;a="Earth"==worldAtDepth(n.depth).name?n.depth<500?earthCave1:earthCave2:n.depth<1500?moonCave1:moonCave2,drawImageFitInBox(MAIN,a,e,i-.03*mainh,.06*mainw,.12*mainh,"center","bottom"),MAIN.save(),MAIN.font="10px Verdana",MAIN.fillStyle="#FFFFFF",MAIN.strokeStyle="#000000",MAIN.lineWidth=3;var l=(.06*mainw-MAIN.measureText(formattedCountDown(t)).width)/2;MAIN.strokeText(formattedCountDown(t),e+l,i+.12*mainh-.03*mainh),MAIN.fillText(formattedCountDown(t),e+l,i+.12*mainh-.03*mainh),MAIN.restore()}}}}function renderCaveSystemHitbox(){return function(e){var i=e.hitbox,n=i.getGlobalCoordinates(0,0);if(null!=getCaveAtDepth(e.depth)){var t=getCaveAtDepth(e.depth).remainingSeconds;if(t>0){var a=earthCave1;"Earth"==worldAtDepth(e.depth).name?a=e.depth<500?earthCave1:earthCave2:"Moon"==worldAtDepth(e.depth).name&&(a=e.depth<1500?moonCave1:moonCave2);var l=2*i.boundingBox.width;drawImageFitInBox(MAIN,a,n.x-(l-i.boundingBox.width)/2,n.y,l,i.boundingBox.height,"center","bottom"),MAIN.save(),MAIN.font="14px Verdana",MAIN.fillStyle="#FFFFFF",MAIN.strokeStyle="#000000",MAIN.lineWidth=3,MAIN.textBaseline="top";var r=1.5*this.boundingBox.width;strokeTextShrinkToFit(MAIN,formattedCountDown(t),n.x+(i.boundingBox.width-r)/2,n.y+i.boundingBox.height-13,r,"center"),fillTextShrinkToFit(MAIN,formattedCountDown(t),n.x+(i.boundingBox.width-r)/2,n.y+i.boundingBox.height-13,r,"center"),MAIN.restore()}}i.renderChildren()}}function onClickedCaveSystem(e){null!=getCaveAtDepth(e.depth)&&(mutebuttons||clickMineral[rand(0,clickMineral.length-1)].play(),openUi(CaveWindow,null,e.depth))}function isUfoVisible(){return 0==hasFoundUfo&&depth>1e3&&currentTime()/6e4%600<=15}