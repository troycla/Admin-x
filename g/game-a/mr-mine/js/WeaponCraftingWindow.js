class WeaponCraftingWindow extends TabbedPopupWindow{layerName="weaponcrafting";domElementId="CRAFTINGD";context=CRAFTING;blueprintPane;blueprintPaneDefaultWidth;blueprintListHitboxes;craftingPane;isCraftingPaneInitialized=!1;selectedBlueprint;craftCategory=2;constructor(t){super(t),t||this.setBoundingBox(),this.context.imageSmoothingEnabled=!1,this.initializeTabs([_("Craft"),_("Weapon Stats")]),this.blueprintPaneDefaultWidth=.4*this.bodyContainer.boundingBox.width,this.blueprintPane=new Scrollbox(this.blueprintPaneDefaultWidth-15,this.bodyContainer.boundingBox.height,this.context,this.bodyContainer.boundingBox.x,this.bodyContainer.boundingBox.y,this.blueprintPaneDefaultWidth,this.bodyContainer.boundingBox.height,15),this.addHitbox(this.blueprintPane),this.craftingPane=new Hitbox({x:this.blueprintPaneDefaultWidth,y:0,width:this.bodyContainer.boundingBox.width-this.blueprintPaneDefaultWidth,height:this.bodyContainer.boundingBox.height},{},"","craftingPane"),this.craftingPane.render=function(){var t=this.parent.parent.context,e=this.getRelativeCoordinates(0,0,this.parent.parent);t.save(),t.fillStyle="#444444",t.fillRect(e.x,e.y,3,this.boundingBox.height),this.renderChildren()},this.craftingPane.allowBubbling=!0,this.bodyContainer.addHitbox(this.craftingPane),this.initializeBlueprintList(),this.initializeCraftingPane(),this.initializeEquipList()}render(){if(0==this.currentTabIndex){if(this.context.save(),this.context.clearRect(0,0,this.boundingBox.width,this.boundingBox.height),isKnownBlueprintsDirty&&(this.initializeBlueprintList(),isKnownBlueprintsDirty=!1),this.blueprintListHitboxes.length>0){for(var t=1;t<this.blueprintListHitboxes.length;++t)this.blueprintListHitboxes[t].boundingBox.y!=this.blueprintListHitboxes[t-1].boundingBox.y+this.blueprintListHitboxes[t-1].boundingBox.height+2&&(this.blueprintListHitboxes[t].boundingBox.y=this.blueprintListHitboxes[t-1].boundingBox.y+this.blueprintListHitboxes[t-1].boundingBox.height+2);var e=this.blueprintListHitboxes[t-1].boundingBox.y+this.blueprintListHitboxes[t-1].boundingBox.height+2;e!=this.blueprintPane.contentHeight&&(this.blueprintPane.contentHeight=e,this.blueprintPane.initializeScrollbar(),this.blueprintPane.render(),this.blueprintPane.scrollTo(this.blueprintPane.currentScrollY))}this.context.restore(),super.render()}else if(1==this.currentTabIndex){this.context.save(),this.context.clearRect(0,0,this.boundingBox.width,this.boundingBox.height),super.render(),this.context.font="20px Verdana";var i=userMaxHealth(),n=_("Max Health: {0}  -  Total DPS: {1}",beautifynum(i),getTotalDps().toFixed(3));this.context.strokeText(n,.5*this.boundingBox.width-this.context.measureText(n).width/2,.86*this.boundingBox.height),this.context.fillText(n,.5*this.boundingBox.width-this.context.measureText(n).width/2,.86*this.boundingBox.height),this.context.restore()}showTyrusDialogue()}close(){return activeLayers.MainUILayer.removeDialogueAttachment(),animate(),super.close()}onTabChange(){this.selectedBlueprint=null,this.blueprintListHitboxes=[],0==this.currentTabIndex?(this.craftingPane.setVisible(!0),this.craftingPane.setEnabled(!0),this.blueprintPane.setVisible(!0),this.blueprintPane.setEnabled(!0),this.equipList.setVisible(!1),this.equipList.setEnabled(!1),this.blueprintPane.scrollTo(0),this.initializeBlueprintList(),this.initializeCraftingPane(),this.blueprintPane.contentHeight=1,this.blueprintPane.clearCanvas(),this.blueprintPane.initializeScrollbar()):1==this.currentTabIndex&&(this.craftingPane.setVisible(!1),this.craftingPane.setEnabled(!1),this.blueprintPane.setVisible(!1),this.blueprintPane.setEnabled(!1),this.equipList.setVisible(!0),this.equipList.setEnabled(!0))}initializeBlueprintList(t=[]){var e=this.blueprintPane;for(var i in e.clearHitboxes(),this.blueprintListHitboxes)this.blueprintListHitboxes[i].isCollapsed||t.push(i);this.blueprintListHitboxes=[];var n,o=0;if(0==this.currentTabIndex){n=getKnownBlueprints();var r=filterBlueprintsByCategory(n,this.craftCategory);r=filterBlueprints(r,(function(t){return!t.craftedItem.item.isAtMaxLevel()})),r=sortBlueprintsBySubcategory(r)}for(var a in r){var s=new CollapsibleMenu(e.context,0,o,e.boundingBox.width-e.scrollbarWidth,40,0,a,"18px Verdana","#FFFFFF");this.generateSubcategoryMenuContents(r[a],s),this.blueprintListHitboxes.push(s),e.addHitbox(s),o+=s.boundingBox.height}if(t.length>0)for(var i in t)this.blueprintListHitboxes[t[i]]&&this.blueprintListHitboxes[t[i]].expand();else 1==this.blueprintListHitboxes.length&&this.blueprintListHitboxes[0].expand();e.isDirty=!0}generateSubcategoryMenuContents(t,e){var i=Math.min(50,Math.floor(.117*this.boundingBox.height)),n=Math.floor((e.boundingBox.width-6)/i),o=Math.ceil(t.length/n),r=(e.boundingBox.width-6-i*n)/(n-1);e.canvas.height=o*(i+r)+6,e.expandedHeight=e.canvas.height+e.collapsedHeight,e.context.save(),e.showNotificationIcon=!1;for(var a=0;a<t.length;++a){var s=t[a];if(s){var h=3+a%n*(i+r),l=3+Math.floor(a/n)*(i+r);if(drawImageFitInBox(e.context,s.craftedItem.item.getIcon(),h,l,i,i),this.selectedBlueprint==s&&(e.context.strokeStyle="#76E374",e.context.lineWidth=3,e.context.beginPath(),e.context.strokeRect(h+e.context.lineWidth,l+e.context.lineWidth,i-2*e.context.lineWidth,i-2*e.context.lineWidth),e.context.stroke()),isBlueprintUnseen(s.category,s.id)){e.showNotificationIcon=!0;e.context.fillStyle="#FF0000",e.context.strokeStyle="#FFFFFF",e.context.lineWidth=2,e.context.beginPath(),e.context.arc(h+i-5,l+5,5,0,2*Math.PI),e.context.fill(),e.context.stroke()}e.context.fillStyle="#FFFFFF";var d=Math.min(16,.037*this.boundingBox.height);e.context.font=d+"px Verdana",e.context.textBaseline="bottom",e.context.lineWidth=3,e.context.strokeStyle="#000000",strokeTextShrinkToFit(e.context,s.craftedItem.item.getCurrentLevel()+2,h,l+i,i,"right"),fillTextShrinkToFit(e.context,s.craftedItem.item.getCurrentLevel()+2,h,l+i,i,"right");var u=new Hitbox({x:h,y:l+e.collapsedHeight,width:i,height:i},{onmousedown:function(t){this.selectedBlueprint=t,this.initializeCraftingPane()}.bind(this,s),onmouseenter:function(t,e,i){var n=this.getGlobalCoordinates(e,i);showTooltip(_(t.craftedItem.item.getName()),_(t.craftedItem.item.getDescription()),n.x*uiScaleX,n.y*uiScaleY,200)}.bind(e,s,h,l+i+e.collapsedHeight),onmouseexit:function(){hideTooltip()}},"pointer");e.addHitbox(u,!0)}}e.context.restore()}initializeCraftingPane(){if(this.selectedBlueprint){0==this.currentTabIndex&&isBlueprintUnseen(this.selectedBlueprint.category,this.selectedBlueprint.id)&&flagBlueprintAsSeen(this.selectedBlueprint.category,this.selectedBlueprint.id),this.initializeBlueprintList(),this.craftingPane.clearHitboxes();var t=isBlueprintKnown(this.selectedBlueprint.category,this.selectedBlueprint.craftedItem.item.id),e=isBlueprintAvailable(this.selectedBlueprint.category,this.selectedBlueprint.craftedItem.item.id),i=.07*this.boundingBox.height,n=Math.min(55,Math.floor(.128*this.boundingBox.height)),o=n/10,r=new Hitbox({x:20,y:i,width:this.craftingPane.boundingBox.width-40,height:n+2*o},{},"");r.render=function(t){var e=t.getContext(),i=this.getRelativeCoordinates(0,0,t);e.save(),e.globalAlpha=.6,e.fillStyle="#111111",e.fillRect(i.x,i.y,this.boundingBox.width,this.boundingBox.height),e.globalAlpha=1;var r=Math.min(22,.051*t.boundingBox.height);e.font=r+"px KanitM",e.fillStyle="#FFFFFF",e.textBaseline="top",fillTextWrap(e,t.selectedBlueprint.craftedItem.item.getName(),i.x+n+4*o,i.y+o,this.boundingBox.width-n-5*o,"left",.25),e.restore(),this.renderChildren()}.bind(r,this);var a=new Hitbox({x:o,y:o,width:n,height:n},{onmouseenter:function(t,e,i){var n=this.getGlobalCoordinates(e,i),o=getRawIngredientsForBlueprint(t);_("Requires");for(var r in o)r+": "+o[r]+"<br>";showTooltip(_(t.craftedItem.item.getName()),t.craftedItem.item.getDescription(),n.x*uiScaleX,n.y*uiScaleY,200)}.bind(r,this.selectedBlueprint,o,o+n),onmouseexit:function(){hideTooltip()}},"pointer");a.render=function(t){var e=this.getContext(),i=t.selectedBlueprint,o=this.getRelativeCoordinates(0,0,t);drawImageFitInBox(e,i.craftedItem.item.getIcon(),o.x,o.y,n,n),e.fillStyle="#FFFFFF";var r=Math.min(16,.037*t.boundingBox.height);e.font=r+"px Verdana",e.textBaseline="bottom",e.lineWidth=3,e.strokeStyle="#000000",strokeTextShrinkToFit(e,i.craftedItem.item.getCurrentLevel()+2,o.x,o.y+n,n,"right"),fillTextShrinkToFit(e,i.craftedItem.item.getCurrentLevel()+2,o.x,o.y+n,n,"right")}.bind(a,this);var s=Math.min(16,.037*this.boundingBox.height),h=new Hitbox({x:20,y:s+r.boundingBox.y+r.boundingBox.height+o,width:r.boundingBox.width,height:3*o+2*n+s},{},"","ingredients");h.render=function(t){var e=this.getContext(),i=this.getRelativeCoordinates(0,0,t);e.save(),0==t.currentTabIndex&&(e.globalAlpha=.6,e.fillStyle="#111111",e.fillRect(i.x,i.y+5*s,this.boundingBox.width,this.boundingBox.height-5*s),e.globalAlpha=1,e.fillStyle="#FFFFFF",e.font=s+"px KanitM",fillTextWrap(e,t.selectedBlueprint.craftedItem.item.getDescription(),i.x,i.y+s,t.boundingBox.width,"left",.25)),e.restore(),this.renderChildren()}.bind(h,this);var l=Math.floor((h.boundingBox.width-2*o)/n),d=(h.boundingBox.width-2*o-n*l)/(l-1);if(t||e){var u=5*s,x=this.selectedBlueprint.craftedItem.item.getCurrentLevel(),g=getBlueprintIngredients(this.craftCategory,this.selectedBlueprint.id,x+1);for(var b in g){var c=o+b%l*(n+d),p=o+Math.floor(b/l)*(n+d),f=new Hitbox({x:c,y:p+u,width:n,height:n},{onmousedown:function(t){}.bind(this,getBlueprintForCraftingItem(g[b].item,!0)),onmouseenter:function(t,e,i){var n=this.getGlobalCoordinates(e,i);showTooltip(_(t.item.getName()),_("Owned: {0}<br>Required: {1}",beautifynum(t.item.getQuantityOwned()),beautifynum(t.quantity)),n.x*uiScaleX,n.y*uiScaleY)}.bind(h,g[b],c,p+n+s),onmouseexit:function(){hideTooltip()}},"pointer");f.render=function(t,e){var i=this.getContext(),o=this.getRelativeCoordinates(0,0,t);drawImageFitInBox(i,e.item.getIcon(),o.x,o.y,n,n),i.fillStyle="#FFFFFF";var r=Math.min(16,.037*t.boundingBox.height);i.font=r+"px Verdana",i.textBaseline="bottom",i.lineWidth=3,i.strokeStyle="#000000",strokeTextShrinkToFit(i,shortenNum(e.quantity),o.x,o.y+n,.95*n,"right"),fillTextShrinkToFit(i,shortenNum(e.quantity),o.x,o.y+n,.95*n,"right"),e.item.hasQuantity(e.quantity)?renderCheckmark(i,o.x,o.y,n/5,n/5):renderXMark(i,o.x,o.y,n/5,n/5)}.bind(f,this,g[b]),h.addHitbox(f)}}var B=new Hitbox({x:r.boundingBox.x+.05*r.boundingBox.width,y:this.craftingPane.boundingBox.height-i-10,width:.9*r.boundingBox.width,height:38},{onmousedown:function(){var e=this.selectedBlueprint.craftedItem.item.getCurrentLevel();t&&0==this.currentTabIndex&&craftBlueprint(this.selectedBlueprint.category,this.selectedBlueprint.id,e+1)&&(this.initializeCraftingPane(),newNews(_("You crafted {0}",this.selectedBlueprint.craftedItem.item.getName()),!0),mutebuttons||armoryUpgradeAudio.play())}.bind(this),onmouseexit:function(){hideTooltip()}},"pointer","craftButton");B.onmouseenter=function(t){if(0==t.currentTabIndex&&!canCraftBlueprint(t.selectedBlueprint.category,t.selectedBlueprint.id)){var e=this.getGlobalCoordinates(0,this.boundingBox.height),i=t.selectedBlueprint.craftedItem.item.getCurrentLevel();showTooltip(getBlueprintNotCraftableReason(t.selectedBlueprint.category,t.selectedBlueprint.id,i+1),"",e.x,e.y)}}.bind(B,this),B.render=function(e){var i=e.context;i.save();var n,o=this.getRelativeCoordinates(0,0,e),r=e.selectedBlueprint.craftedItem.item.getCurrentLevel();0==e.currentTabIndex&&t&&canCraftBlueprint(e.selectedBlueprint.category,e.selectedBlueprint.id,r+1)?(i.drawImage(upgradeb,o.x,o.y,this.boundingBox.width,this.boundingBox.height),i.fillStyle="#000000"):(i.drawImage(upgradebg_blank,o.x,o.y,this.boundingBox.width,this.boundingBox.height),i.fillStyle="#444444"),i.textBaseline="middle";var a=Math.min(32,.074*e.boundingBox.height);i.font=a+"px KanitB",0==e.currentTabIndex&&(n=r<0?_("Craft"):r>=e.selectedBlueprint.levels.length-1?_("Max Level"):_("Upgrade")),fillTextShrinkToFit(i,n,o.x+10,o.y+this.boundingBox.height/2+2,this.boundingBox.width-20,"center"),i.restore()}.bind(B,this),this.craftingPane.addHitbox(r),r.addHitbox(a),this.craftingPane.addHitbox(h),this.craftingPane.addHitbox(B),this.isCraftingPaneInitialized=!0}else{var y="",m="";0==this.currentTabIndex&&(getAvailableBlueprints().length>0&&(y=_("Click on a blueprint on the left to view it")),m=_("Find more weapons from chests and battles")),this.craftingPane.clearHitboxes();var v=new Hitbox({x:10,y:10,width:this.craftingPane.boundingBox.width-20,height:this.craftingPane.boundingBox.height-20},{},"");v.render=function(t){var e=this.getRelativeCoordinates(0,0,t),i=t.context;i.fillStyle="#FFFFFF",i.textBaseline="middle",fillTextWrap(i,y,e.x,e.y+10,this.boundingBox.width),fillTextWrap(i,m,e.x,e.y+70,this.boundingBox.width)}.bind(v,this),this.craftingPane.addHitbox(v)}}initializeEquipList(){for(var t=50,e=new Hitbox({x:28,y:58,width:this.bodyContainer.boundingBox.width-60,height:this.bodyContainer.boundingBox.height},{},"","equipList"),i=0;i<battleInventory.length;++i)if(battleInventory[i].length>0){var n=i%3*193,o=58*Math.floor(i/3),r=new Hitbox({x:n,y:o,width:t,height:t},{onmouseenter:function(t,e,i){var n=new WeaponCraftingItem(battleInventory[t][0]),o=this.getGlobalCoordinates(e,i);showTooltip(_(n.getName()),_(n.getDescription()),o.x*uiScaleX,o.y*uiScaleY)}.bind(e,i,n+t,o),onmouseexit:function(){hideTooltip()}},"pointer");r.render=function(e,i){var n=new WeaponCraftingItem(battleInventory[i][0]),o=this.getRelativeCoordinates(0,0,e);e.context.drawImage(darkdot,o.x-2,o.y-2,this.boundingBox.width+135+2,this.boundingBox.height+4),e.context.drawImage(n.getIcon(),o.x,o.y,this.boundingBox.width,this.boundingBox.height),e.context.fillStyle="#FFFFFF";var r=Math.min(16,.037*e.boundingBox.height);e.context.font=r+"px Verdana",e.context.textBaseline="bottom",e.context.lineWidth=3,e.context.strokeStyle="#000000",strokeTextShrinkToFit(e.context,n.getCurrentLevel()+1,o.x,o.y+this.boundingBox.width,this.boundingBox.height,"right"),fillTextShrinkToFit(e.context,n.getCurrentLevel()+1,o.x,o.y+this.boundingBox.width,this.boundingBox.height,"right"),e.context.textBaseline="top";r=Math.min(11,.026*e.boundingBox.height);e.context.font=r+"px Verdana",fillTextWrap(e.context,n.getName()+" Lv."+(n.getCurrentLevel()+1)+" <br> ATK: "+n.getAttack()+" <br> CD: "+beautifynum(n.getCooldown())+"ms <br> DPS: "+n.getDps().toFixed(3),o.x+t+3,o.y+1,135,"left",.2)}.bind(r,this,i),e.addHitbox(r)}this.equipList=e,this.addHitbox(e),1!=this.currentTabIndex&&(this.equipList.setEnabled(!1),this.equipList.setVisible(!1))}}