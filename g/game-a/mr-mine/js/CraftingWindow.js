class CraftingWindow extends TabbedPopupWindow{layerName="crafting";domElementId="CRAFTINGD";context=CRAFTING;blueprintPane;blueprintPaneDefaultWidth;blueprintListHitboxes;craftingPane;isCraftingPaneInitialized=!1;selectedBlueprint;discountedIngredients;constructor(t,e=0,i=0){super(t),t||this.setBoundingBox(),this.setFrameImagesByWorldIndex(e),this.context.imageSmoothingEnabled=!1,this.initializeTabs([_("Craft"),_("Structures")]),this.currentTabIndex=i,this.blueprintPaneDefaultWidth=.4*this.bodyContainer.boundingBox.width,this.blueprintPane=new Scrollbox(this.blueprintPaneDefaultWidth-15,this.bodyContainer.boundingBox.height,this.context,this.bodyContainer.boundingBox.x,this.bodyContainer.boundingBox.y,this.blueprintPaneDefaultWidth,this.bodyContainer.boundingBox.height,15),this.addHitbox(this.blueprintPane),this.craftingPane=new Hitbox({x:this.blueprintPaneDefaultWidth,y:0,width:this.bodyContainer.boundingBox.width-this.blueprintPaneDefaultWidth,height:this.bodyContainer.boundingBox.height},{},"","craftingPane"),this.craftingPane.render=function(){var t=this.parent.parent.context,e=this.getRelativeCoordinates(0,0,this.parent.parent);t.save(),t.fillStyle="#444444",t.fillRect(e.x,e.y,3,this.boundingBox.height),this.renderChildren()},this.craftingPane.allowBubbling=!0,this.bodyContainer.addHitbox(this.craftingPane),this.initializeBlueprintList(),this.initializeCraftingPane(),this.initializeEquipList()}render(){if(0==this.currentTabIndex){var t=2;if(this.context.save(),this.context.clearRect(0,0,this.boundingBox.width,this.boundingBox.height),isKnownBlueprintsDirty&&(this.initializeBlueprintList(),isKnownBlueprintsDirty=!1),this.blueprintListHitboxes.length>0){for(var e=1;e<this.blueprintListHitboxes.length;++e)this.blueprintListHitboxes[e].boundingBox.y!=this.blueprintListHitboxes[e-1].boundingBox.y+this.blueprintListHitboxes[e-1].boundingBox.height+t&&(this.blueprintListHitboxes[e].boundingBox.y=this.blueprintListHitboxes[e-1].boundingBox.y+this.blueprintListHitboxes[e-1].boundingBox.height+t);(r=this.blueprintListHitboxes[e-1].boundingBox.y+this.blueprintListHitboxes[e-1].boundingBox.height+t)!=this.blueprintPane.contentHeight&&(this.blueprintPane.contentHeight=r,this.blueprintPane.initializeScrollbar(),this.blueprintPane.render(),this.blueprintPane.scrollTo(this.blueprintPane.currentScrollY))}if(this.context.restore(),super.render(),hasUnseenDrillBlueprints()){var i=1500,n=1;(s=Math.floor((new Date).getTime())%i/(i/2))>1&&(s=2-s),this.context.globalAlpha=n*s;var o=5;this.context.fillStyle="#FF0000",this.context.strokeStyle="#FFFFFF",this.context.lineWidth=2,this.context.beginPath(),this.context.arc(this.tabs[0].boundingBox.x+this.tabs[0].boundingBox.width-2*o,this.tabs[0].boundingBox.y+2*o,o,0,2*Math.PI),this.context.fill(),this.context.stroke(),this.context.globalAlpha=1}}else if(1==this.currentTabIndex){t=2;if(this.context.save(),this.context.clearRect(0,0,this.boundingBox.width,this.boundingBox.height),isKnownBlueprintsDirty&&(this.initializeBlueprintList(),isKnownBlueprintsDirty=!1),this.blueprintListHitboxes.length>0){for(e=1;e<this.blueprintListHitboxes.length;++e)this.blueprintListHitboxes[e].boundingBox.y!=this.blueprintListHitboxes[e-1].boundingBox.y+this.blueprintListHitboxes[e-1].boundingBox.height+t&&(this.blueprintListHitboxes[e].boundingBox.y=this.blueprintListHitboxes[e-1].boundingBox.y+this.blueprintListHitboxes[e-1].boundingBox.height+t);var r;(r=this.blueprintListHitboxes[e-1].boundingBox.y+this.blueprintListHitboxes[e-1].boundingBox.height+t)!=this.blueprintPane.contentHeight&&(this.blueprintPane.contentHeight=r,this.blueprintPane.initializeScrollbar(),this.blueprintPane.render(),this.blueprintPane.scrollTo(this.blueprintPane.currentScrollY))}if(this.context.restore(),super.render(),hasUnseenStructureBlueprints()){var s;i=1500,n=1;(s=Math.floor((new Date).getTime())%i/(i/2))>1&&(s=2-s),this.context.globalAlpha=n*s;o=5;this.context.fillStyle="#FF0000",this.context.strokeStyle="#FFFFFF",this.context.lineWidth=2,this.context.beginPath(),this.context.arc(this.tabs[1].boundingBox.x+this.tabs[0].boundingBox.width-2*o,this.tabs[1].boundingBox.y+2*o,o,0,2*Math.PI),this.context.fill(),this.context.stroke(),this.context.globalAlpha=1}}0==this.currentTabIndex&&this.selectedBlueprint&&"Golem"==this.selectedBlueprint.shopSubcategory?showGolemDialogue():0==this.currentTabIndex&&this.selectedBlueprint&&"Broken Robot"==this.selectedBlueprint.shopSubcategory?showGidgetDialogue():showMechanicDialogue()}close(){return activeLayers.MainUILayer.removeDialogueAttachment(),animate(),super.close()}onTabChange(){this.selectedBlueprint=null,this.blueprintListHitboxes=[],this.currentTabIndex<=1&&(this.craftingPane.setVisible(!0),this.craftingPane.setEnabled(!0),this.blueprintPane.setVisible(!0),this.blueprintPane.setEnabled(!0),this.equipList.setVisible(!1),this.equipList.setEnabled(!1),this.blueprintPane.scrollTo(0),this.initializeBlueprintList(),this.initializeCraftingPane(),this.blueprintPane.contentHeight=1,this.blueprintPane.clearCanvas(),this.blueprintPane.initializeScrollbar()),this.tutorialFlicker()}initializeBlueprintList(t=[]){var e,i=this.blueprintPane;for(var n in i.clearHitboxes(),this.blueprintListHitboxes)this.blueprintListHitboxes[n].isCollapsed||t.push(n);this.blueprintListHitboxes=[];var o,r=0;if(0==this.currentTabIndex){e=1,o=getKnownBlueprints();var s=filterBlueprintsByCategoryAndLevel(o,e);s=sortBlueprintsByShopSubcategory(s)}else if(1==this.currentTabIndex){e=3,o=getKnownBlueprints();s=filterBlueprintsByCategory(o,e);s=sortBlueprintsBySubcategory(s)}for(var l in s){var a=new CollapsibleMenu(i.context,0,r,i.boundingBox.width-i.scrollbarWidth,40,0,l,"18px Verdana","#FFFFFF");this.generateSubcategoryMenuContents(s[l],a),this.blueprintListHitboxes.push(a),i.addHitbox(a),r+=a.boundingBox.height}if(t.length>0)for(var n in t)this.blueprintListHitboxes[t[n]]&&this.blueprintListHitboxes[t[n]].expand();else 1==this.blueprintListHitboxes.length&&this.blueprintListHitboxes[0].expand();i.isDirty=!0}generateSubcategoryMenuContents(t,e){var i=Math.min(50,Math.floor(.117*this.boundingBox.height)),n=Math.floor((e.boundingBox.width-6)/i),o=Math.ceil(t.length/n),r=(e.boundingBox.width-6-i*n)/(n-1);e.canvas.height=o*(i+r)+6,e.expandedHeight=e.canvas.height+e.collapsedHeight,e.context.save(),e.showNotificationIcon=!1;for(var s=0;s<t.length;++s){var l=t[s];if(l){var a=3+s%n*(i+r),h=3+Math.floor(s/n)*(i+r);if(drawImageFitInBox(e.context,l.craftedItem.item.getIcon(),a,h,i,i),this.selectedBlueprint==l&&(e.context.strokeStyle="#76E374",e.context.lineWidth=3,e.context.beginPath(),e.context.strokeRect(a+e.context.lineWidth,h+e.context.lineWidth,i-2*e.context.lineWidth,i-2*e.context.lineWidth),e.context.stroke()),isBlueprintUnseen(l.category,l.id)){e.showNotificationIcon=!0;e.context.fillStyle="#FF0000",e.context.strokeStyle="#FFFFFF",e.context.lineWidth=2,e.context.beginPath(),e.context.arc(a+i-5,h+5,5,0,2*Math.PI),e.context.fill(),e.context.stroke()}if(3==l.category&&l.craftedItem.item.getQuantityOwned()>-1){e.context.fillStyle="#FFFFFF",e.context.strokeStyle="#000000";var d=Math.min(16,.037*this.boundingBox.height);e.context.font=d+"px Verdana",e.context.textBaseline="bottom",e.context.lineWidth=3,l.craftedItem.item.isAtMaxLevel()?(strokeTextShrinkToFit(e.context,_("max"),a,h+i,i,"right"),fillTextShrinkToFit(e.context,_("max"),a,h+i,i,"right")):(strokeTextShrinkToFit(e.context,l.craftedItem.item.getCurrentLevel()+1,a,h+i,i,"right"),fillTextShrinkToFit(e.context,l.craftedItem.item.getCurrentLevel()+1,a,h+i,i,"right"))}var u=new Hitbox({x:a,y:h+e.collapsedHeight,width:i,height:i},{onmousedown:function(t){if(this.selectedBlueprint=t,t.hasOwnProperty("levels")){var e=t.craftedItem.item.getCurrentLevel();t.craftedItem.item.isAtMaxLevel()?this.discountedIngredients=null:this.discountedIngredients=getIngredientListWithDiscounts(t.levels[e].ingredients)}else this.discountedIngredients=getIngredientListWithDiscounts(t.ingredients);this.initializeCraftingPane()}.bind(this,l),onmouseenter:function(t,e,i){var n=this.getGlobalCoordinates(e,i);showTooltip(_(t.craftedItem.item.getName()),_(t.craftedItem.item.getDescription()),n.x*uiScaleX,n.y*uiScaleY)}.bind(e,l,a,h+i+e.collapsedHeight),onmouseexit:function(){hideTooltip()}},"pointer");e.addHitbox(u,!0)}}e.context.restore()}initializeCraftingPane(){if(this.selectedBlueprint){if(1==this.currentTabIndex&&this.selectedBlueprint.hasOwnProperty("levels")){var t=this.selectedBlueprint.craftedItem.item.getCurrentLevel();this.selectedBlueprint.craftedItem.item.isAtMaxLevel()?this.discountedIngredients=null:this.discountedIngredients=getIngredientListWithDiscounts(this.selectedBlueprint.levels[t].ingredients)}isBlueprintUnseen(this.selectedBlueprint.category,this.selectedBlueprint.id)&&flagBlueprintAsSeen(this.selectedBlueprint.category,this.selectedBlueprint.id),this.initializeBlueprintList(),this.craftingPane.clearHitboxes();var e=isBlueprintKnown(this.selectedBlueprint.category,this.selectedBlueprint.id),i=isBlueprintAvailable(this.selectedBlueprint.category,this.selectedBlueprint.id),n=.02*this.boundingBox.height,o=Math.min(55,Math.ceil(.128*this.boundingBox.height)),r=o/10,s=new Hitbox({x:20,y:n,width:this.craftingPane.boundingBox.width-40,height:o+2*r},{},"","blueprintNameBox");s.render=function(t){var e=t.getContext(),i=this.getRelativeCoordinates(0,0,t);e.save(),e.globalAlpha=.6,e.fillStyle="#111111",e.fillRect(i.x,i.y,this.boundingBox.width,this.boundingBox.height),e.globalAlpha=1;var n=Math.min(22,.055*t.boundingBox.height);e.font=n+"px KanitM",e.fillStyle="#FFFFFF",e.textBaseline="top",fillTextWrap(e,t.selectedBlueprint.craftedItem.item.getName(),i.x+o+4*r,i.y+r,this.boundingBox.width-o-5*r,"left",.25),e.restore(),this.renderChildren()}.bind(s,this);var l=new Hitbox({x:r,y:r,width:o,height:o},{onmouseenter:function(t,e,i){var n=this.getGlobalCoordinates(e,i),o=getRawIngredientsForBlueprint(t);_("Requires");for(var r in o)r+": "+o[r]+"<br>";showTooltip(_(t.craftedItem.item.getName()),t.craftedItem.item.getDescription(),n.x*uiScaleX,n.y*uiScaleY)}.bind(s,this.selectedBlueprint,r,r+o),onmouseexit:function(){hideTooltip()}},"pointer","blueprintIcon");l.render=function(t){var e=this.getContext(),i=t.selectedBlueprint,n=this.getRelativeCoordinates(0,0,t);if(drawImageFitInBox(e,i.craftedItem.item.getIcon(),n.x,n.y,o,o),1!=i.category&&i.craftedItem.item.getQuantityOwned()>-1){e.fillStyle="#FFFFFF";var r=Math.min(16,.037*this.boundingBox.height);e.font=r+"px Verdana",e.textBaseline="bottom",strokeTextShrinkToFit(t.context,i.craftedItem.item.getCurrentLevel()+1,n.x,n.y+o,this.boundingBox.height,"right"),fillTextShrinkToFit(t.context,i.craftedItem.item.getCurrentLevel()+1,n.x,n.y+o,this.boundingBox.height,"right")}}.bind(l,this);var a=Math.min(16,.037*this.boundingBox.height),h=new Hitbox({x:20,y:a+s.boundingBox.y+1.5*s.boundingBox.height+r,width:s.boundingBox.width,height:4*r+2*o+2*a},{},"","ingredients");h.render=function(t){var e=this.getContext(),i=this.getRelativeCoordinates(0,0,t),n=.85*i.y;e.save(),0==t.currentTabIndex||1==t.currentTabIndex?(e.fillStyle="#FFFFFF",e.font=a+"px KanitB",fillTextWrap(e,_("Blueprint"),i.x,n,t.boundingBox.width),e.font=a+"px KanitM",drawTextWrap(e,t.selectedBlueprint.craftedItem.item.getDescription(),i.x,n+24,.9*(t.boundingBox.width-i.x),"left",.25),e.globalAlpha=.6,e.fillStyle="#111111",e.fillRect(i.x,i.y+6.5*a,this.boundingBox.width,this.boundingBox.height-6.5*a),e.globalAlpha=1):(e.globalAlpha=.6,e.fillStyle="#111111",e.fillRect(i.x,i.y+6.5*a,this.boundingBox.width,this.boundingBox.height-6.5*a),e.globalAlpha=1,e.fillStyle="#FFFFFF",e.font=a+"px KanitM",fillTextWrap(e,t.selectedBlueprint.craftedItem.item.getDescription(),i.x,i.y+a,t.boundingBox.width,"left",.25)),e.restore(),this.renderChildren()}.bind(h,this);var d=Math.floor((h.boundingBox.width-2*r)/o),u=(h.boundingBox.width-2*r-o*d)/(d-1);if(e||i){var g=6.5*a;for(var c in this.discountedIngredients){var b=r+c%d*(o+u),x=r+Math.floor(c/d)*(o+u),p=new Hitbox({x:b,y:x+g,width:o,height:o},{onmousedown:function(t){t&&(t.category!=this.currentTabIndex&&(this.blueprintPane.scrollTo(0),this.currentTabIndex=t.category+1,this.initializeBlueprintList()),this.selectedBlueprint=t,this.discountedIngredients=getIngredientListWithDiscounts(t.ingredients),this.initializeCraftingPane())}.bind(this,getBlueprintForCraftingItem(this.discountedIngredients[c].item,!0)),onmouseenter:function(t,e,i){var n=this.getGlobalCoordinates(e,i);showTooltip(_(t.item.getName()),_("Owned: {0}<br>Required: {1}",beautifynum(t.item.getQuantityOwned()),beautifynum(t.quantity))+t.item.getDescription(),n.x*uiScaleX,n.y*uiScaleY)}.bind(h,this.discountedIngredients[c],b,x+o+a),onmousedown:function(t){var e=t.item.id,i=mineralIds.includes(e),n=isotopeIds.includes(e);if(n&&99999==getDepthMineralIsFoundAt(e)&&e>highestIsotopeUnlocked){var o=getBombardmentForIsotope(t.item.id);depth>=1134&&o&&(openUi(ReactorWindow,null,1),activeLayers.Reactor.selectedBlueprint=getBlueprintById(6,o.index-1),activeLayers.Reactor.blueprintListHitboxes[5].toggle(),activeLayers.Reactor.initializeCraftingPane())}else if(managerStructure.level>0&&(i||n)){var r="";lockedMineralAmtsToSave[t.item.id]>0&&(r+=_("\n You're currently preventing {0} {1} from being sold. ",beautifynum(lockedMineralAmtsToSave[t.item.id]),t.item.getName())),r+=_("Are you sure you want to prevent {0} {1} from being sold?",beautifynum(t.quantity),t.item.getName()),showConfirmationPrompt(r,_("Yes"),(function(){lockedMineralAmtsToSave[t.item.id]=t.quantity,hideSimpleInput()}),_("Cancel"))}}.bind(h,this.discountedIngredients[c]),onmouseexit:function(){hideTooltip()}},"pointer");p.render=function(t,e){var i=this.getContext(),n=this.getRelativeCoordinates(0,0,t);drawImageFitInBox(i,e.item.getIcon(),n.x,n.y,o,o),i.fillStyle="#FFFFFF";var r=Math.min(16,.037*t.boundingBox.height);i.font=r+"px Verdana",i.textBaseline="bottom",i.lineWidth=3,i.strokeStyle="#000000",strokeTextShrinkToFit(i,e.item.getFormattedQuantity(e.quantity),n.x,n.y+o,.95*o,"right"),fillTextShrinkToFit(i,e.item.getFormattedQuantity(e.quantity),n.x,n.y+o,.95*o,"right"),e.item.hasQuantity(e.quantity)?renderCheckmark(i,n.x,n.y,o/5,o/5):renderXMark(i,n.x,n.y,o/5,o/5)}.bind(p,this,this.discountedIngredients[c]),h.addHitbox(p)}}var f=new Hitbox({x:s.boundingBox.x+.05*s.boundingBox.width,y:this.craftingPane.boundingBox.height-.075*this.boundingBox.height*1.1,width:.8*s.boundingBox.width,height:.075*this.boundingBox.height},{onmousedown:function(){if(e&&0==this.currentTabIndex)craftBlueprint(this.selectedBlueprint.category,this.selectedBlueprint.id,0,this.discountedIngredients)&&(newNews(_("You crafted {0}",this.selectedBlueprint.craftedItem.item.getName()),!0),pinnedBlueprintsManager.update(),mutebuttons||craftDrillAudio.play());else if(e&&1==this.currentTabIndex){var t=this.selectedBlueprint.craftedItem.item.getCurrentLevel();craftBlueprint(this.selectedBlueprint.category,this.selectedBlueprint.id,t+1,this.discountedIngredients)&&(newNews(_("You crafted {0}",this.selectedBlueprint.craftedItem.item.getName()),!0),pinnedBlueprintsManager.update(),mutebuttons||craftStructureAudio.play())}this.initializeCraftingPane()}.bind(this),onmouseexit:function(){hideTooltip()}},"pointer","craftButton");f.onmouseenter=function(t){if(0==t.currentTabIndex&&!canCraftBlueprint(t.selectedBlueprint.category,t.selectedBlueprint.id,0,t.discountedIngredients)){var e=this.getGlobalCoordinates(0,this.boundingBox.height);showTooltip(getBlueprintNotCraftableReason(t.selectedBlueprint.category,t.selectedBlueprint.id),"",e.x,e.y)}}.bind(f,this),f.render=function(t){var i=t.context;i.save();var n,o=this.getRelativeCoordinates(0,0,t);if(0==t.currentTabIndex)e&&canCraftBlueprint(t.selectedBlueprint.category,t.selectedBlueprint.id,0,t.discountedIngredients)?(i.drawImage(upgradeb,o.x,o.y,this.boundingBox.width,this.boundingBox.height),i.fillStyle="#000000"):(i.drawImage(upgradebg_blank,o.x,o.y,this.boundingBox.width,this.boundingBox.height),i.fillStyle="#444444");else if(1==t.currentTabIndex){var r=t.selectedBlueprint.craftedItem.item.getCurrentLevel()+1;e&&canCraftBlueprint(t.selectedBlueprint.category,t.selectedBlueprint.id,r,t.discountedIngredients)?(i.drawImage(upgradeb,o.x,o.y,this.boundingBox.width,this.boundingBox.height),i.fillStyle="#000000"):(i.drawImage(upgradebg_blank,o.x,o.y,this.boundingBox.width,this.boundingBox.height),i.fillStyle="#444444")}if(i.textBaseline="middle",0==t.currentTabIndex)if(drillState.equippedDrillEquips.indexOf(getDrillEquipByBlueprintId(t.selectedBlueprint.id).id)>-1){n=_("Equipped");var s=Math.min(26,.065*t.boundingBox.height);i.font=s+"px KanitB"}else{n=_("Craft");s=Math.min(32,.08*t.boundingBox.height);i.font=s+"px KanitB"}else if(1==t.currentTabIndex){n=_("Craft");s=Math.min(32,.08*t.boundingBox.height);i.font=s+"px KanitB"}fillTextShrinkToFit(i,n,o.x+10,o.y+this.boundingBox.height/2+2,this.boundingBox.width-20,"center"),i.restore()}.bind(f,this),this.craftingPane.addHitbox(s),s.addHitbox(l),this.craftingPane.addHitbox(h),this.craftingPane.addHitbox(f),this.isCraftingPaneInitialized=!0}else{var B;0!=this.currentTabIndex&&1!=this.currentTabIndex||(B=0==knownBlueprints.length||1==knownBlueprints.length&&""==knownBlueprints[0]?_("You don't own any blueprints. Find more in the mines."):_("Click on a blueprint on the left to craft it")),this.craftingPane.clearHitboxes();var m=new Hitbox({x:20,y:20,width:this.craftingPane.boundingBox.width-40,height:this.craftingPane.boundingBox.height-40},{},"","instructionsHitbox");m.render=function(t){var e=this.getRelativeCoordinates(0,0,t),i=t.context;i.font="18px Verdana",i.fillStyle="#FFFFFF",i.textBaseline="middle",fillTextWrap(i,B,e.x,e.y+this.boundingBox.height/2-30,this.boundingBox.width)}.bind(m,this),this.craftingPane.addHitbox(m)}}initializeEquipList(){for(var t=Math.min(55,Math.ceil(.128*this.boundingBox.height)),e=new Hitbox({x:30,y:this.bodyContainer.boundingBox.height/2-t/2,width:this.bodyContainer.boundingBox.width,height:t},{},"","equipList"),i=0;i<4;++i){var n=new Hitbox({x:i*(t+10),y:0,width:t,height:t},{onmouseenter:function(t,e,i){var n=new DrillCraftingItem(drillState.equippedDrillEquips[t]),o=this.getGlobalCoordinates(e,i);showTooltip(_(n.getName()),_(n.getDescription()),o.x*uiScaleX,o.y*uiScaleY)}.bind(e,i,i*(t+10),t),onmouseexit:function(){hideTooltip()}},"pointer");n.render=function(t,e){var i=new DrillCraftingItem(drillState.equippedDrillEquips[e]),n=this.getRelativeCoordinates(0,0,t);t.context.drawImage(i.getIcon(),n.x,n.y,this.boundingBox.width,this.boundingBox.height)}.bind(n,this,i),e.addHitbox(n)}this.equipList=e,this.addHitbox(e),2!=this.currentTabIndex&&(this.equipList.setEnabled(!1),this.equipList.setVisible(!1))}tutorialFlicker(){return!hasCraftedABlueprint&&canCraftAnyBlueprint(1)?(this.flickerTab(0,500),!0):!(0!=tradingPostStructure.level||!canCraftBlueprint(3,0))&&(this.flickerTab(1,500),!0)}}