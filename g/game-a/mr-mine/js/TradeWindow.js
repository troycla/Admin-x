class TradeWindow extends TabbedPopupWindow{layerName="tradingPost";domElementId="TRADINGPOSTD";context=TRADINGPOST;worldIndex;defaultWidth;defaultHeight;trades=[];tradeBox1;tradeBox2;tradeButton1;tradeButton2;getWorld(){return worlds[this.worldIndex]}constructor(t,i){super(t),t||this.setBoundingBox(),this.setFrameImagesByWorldIndex(i),this.defaultWidth=this.boundingBox.width,this.defaultHeight=this.boundingBox.height,this.initializeTabs([]),this.worldIndex=i,this.tradeBox1=this.createTradeBox(0),this.tradeBox1.boundingBox.x=300,this.tradeBox1.boundingBox.y=100,this.addHitbox(this.tradeBox1),this.tradeBox2=this.createTradeBox(1),this.addHitbox(this.tradeBox2);var e=Math.min(14,.032*this.boundingBox.height);this.tradeButton1=new Button(JustUpgrade,_("MAKE TRADE"),e+"px Verdana","#000000",{x:-100,y:-100,width:.2*this.boundingBox.width,height:.05*this.boundingBox.height},{onmousedown:function(){var t=getTradesForWorld(this.getRootLayer().worldIndex)[0];makeTrade(this.getRootLayer().worldIndex,t),mutebuttons||clickAudio[rand(0,clickAudio.length-1)].play()},onmouseenter:function(){var t=this.getRootLayer().trades[0],i=generateTradeOfferStrings(t),e=this.getGlobalCoordinates(0,this.boundingBox.height);showTooltip(_("Value"),_("Payment Value: ")+i.paymentValueString+"<br><br>"+_("Reward Value: ")+i.rewardValueString,e.x,e.y)},onmouseexit:function(){hideTooltip()}},"pointer","tradeButton1"),this.tradeButton2=new Button(JustUpgrade,_("MAKE TRADE"),e+"px Verdana","#000000",{x:-100,y:-100,width:.2*this.boundingBox.width,height:.05*this.boundingBox.height},{onmousedown:function(){var t=getTradesForWorld(this.getRootLayer().worldIndex)[1];makeTrade(this.getRootLayer().worldIndex,t),mutebuttons||clickAudio[rand(0,clickAudio.length-1)].play()},onmouseenter:function(){var t=this.getRootLayer().trades[1],i=generateTradeOfferStrings(t),e=this.getGlobalCoordinates(0,this.boundingBox.height);showTooltip(_("Value"),_("Payment Value: ")+i.paymentValueString+"<br><br>"+_("Reward Value: ")+i.rewardValueString,e.x,e.y)},onmouseexit:function(){hideTooltip()}},"pointer","tradeButton2"),this.newTradeButton=new Button(JustUpgrade,_("New Trade"),e+"px Verdana","#000000",{x:-100,y:-100,width:.2*this.boundingBox.width,height:.05*this.boundingBox.height},{onmousedown:function(){confirmRerollTrade(this.getRootLayer().worldIndex),mutebuttons||clickAudio[rand(0,clickAudio.length-1)].play()},onmouseenter:function(){var t=this.getGlobalCoordinates(0,this.boundingBox.height);showTooltip(_("New Trade"),_("Pay 1 ticket to get a new trade"),t.x,t.y)},onmouseexit:function(){hideTooltip()}},"pointer","newTradeButton"),this.timer=new Hitbox({x:this.bodyContainer.boundingBox.x+.03*this.boundingBox.width,y:this.bodyContainer.boundingBox.y+this.bodyContainer.boundingBox.height-.16*this.boundingBox.height,width:.2*this.boundingBox.width,height:.08*this.boundingBox.height},{onmouseenter:function(){var t=this.getGlobalCoordinates(0,this.boundingBox.height);showTooltip(_("Time Left In Trade"),"",t.x,t.y)},onmouseexit:function(){hideTooltip()}}),this.extendTradeButton=new Button(JustUpgrade,_("Extend Trade"),e+"px Verdana","#000000",{x:this.timer.boundingBox.x,y:this.timer.boundingBox.y+this.timer.boundingBox.height,width:this.timer.boundingBox.width,height:.05*this.boundingBox.height},{onmousedown:function(){confirmExtendTrade(this.getRootLayer().worldIndex),mutebuttons||clickAudio[rand(0,clickAudio.length-1)].play()},onmouseenter:function(){var t=this.getGlobalCoordinates(0,this.boundingBox.height);showTooltip(_("Extend Trade"),_("Pay 1 ticket to extend the trade duration by 1 hour"),t.x,t.y)},onmouseexit:function(){hideTooltip()}},"pointer","extendTradeButton"),this.addHitbox(this.tradeButton1),this.addHitbox(this.tradeButton2),this.addHitbox(this.newTradeButton),this.addHitbox(this.timer),this.addHitbox(this.extendTradeButton)}render(){if(this.context.save(),this.context.clearRect(0,0,this.defaultWidth,this.defaultHeight),this.context.restore(),super.render(),this.context.fillStyle="#FFFFFF",this.trades=getTradesForWorld(this.worldIndex),isTradeAvailable(this.trades[0])||isTradeAvailable(this.trades[1]))if(isTradeAvailable(this.trades[0])&&isTradeAvailable(this.trades[1])){this.tradeBox1.setVisible(!0),this.tradeBox1.setEnabled(!0),this.tradeBox2.setVisible(!0),this.tradeBox2.setEnabled(!0),this.tradeButton1.setVisible(!0),this.tradeButton1.setEnabled(!0),this.tradeButton2.setVisible(!0),this.tradeButton2.setEnabled(!0),this.newTradeButton.setVisible(!0),this.newTradeButton.setEnabled(!0),this.extendTradeButton.setVisible(!0),this.extendTradeButton.setEnabled(!0);var t=traders[this.worldIndex][this.trades[0][TRADE_INDEX_TRADER]],i=(x=this.trades[0][TRADE_INDEX_START_TIME],a=this.trades[0][TRADE_INDEX_DURATION],getTraderImage(this.worldIndex,this.trades[0][TRADE_INDEX_TRADER])),e=.2*this.boundingBox.width,o=e*(i.height/i.width),n=1.2*e,d=1.2*o;u=Math.min(14,.032*this.boundingBox.height)+"px Verdana";this.context.font=u,this.context.drawImage(darkgreydot,this.bodyContainer.boundingBox.x+.03*this.boundingBox.width,this.bodyContainer.boundingBox.y+.09*this.boundingBox.height,e,o),this.context.drawImage(i,this.bodyContainer.boundingBox.x+.03*this.boundingBox.width,this.bodyContainer.boundingBox.y+.09*this.boundingBox.height,e,o);var h=fillTextShrinkToFit(this.context,t.name,this.bodyContainer.boundingBox.x+.02*this.boundingBox.width,this.bodyContainer.boundingBox.y+d+.09*this.boundingBox.height,n,"center");this.newTradeButton.boundingBox.x=this.bodyContainer.boundingBox.x+.03*this.boundingBox.width,this.newTradeButton.boundingBox.y=h.y1+18;var s=Math.floor(this.trades[0][TRADE_INDEX_START_TIME])%t.introDialogue.length,r=fillTextWrap(this.context,t.introDialogue[s],this.bodyContainer.boundingBox.x+n+30,this.bodyContainer.boundingBox.y+Math.min(40,.066*this.boundingBox.height),this.bodyContainer.boundingBox.width-n-50);this.tradeBox1.boundingBox.x=r.x1,this.tradeBox1.boundingBox.y=r.y2,this.tradeBox1.boundingBox.width=this.bodyContainer.boundingBox.width-n-50,this.tradeButton1.boundingBox.x=this.tradeBox1.boundingBox.x+this.tradeBox1.boundingBox.width/2-.1*this.boundingBox.width,this.tradeButton1.boundingBox.y=this.tradeBox1.boundingBox.y+this.tradeBox1.boundingBox.height+5,this.tradeBox2.boundingBox.x=r.x1,this.tradeBox2.boundingBox.y=this.tradeButton1.boundingBox.y+this.tradeButton1.boundingBox.height+7,this.tradeBox2.boundingBox.width=this.bodyContainer.boundingBox.width-n-50,this.tradeButton2.boundingBox.x=this.tradeBox2.boundingBox.x+this.tradeBox2.boundingBox.width/2-.1*this.boundingBox.width,this.tradeButton2.boundingBox.y=this.tradeBox2.boundingBox.y+this.tradeBox2.boundingBox.height+5;B=a-(currentTime()/1e3-x);renderProgressBar(this.context,formattedCountDown(B),darkdot,darkdot,this.timer.boundingBox.x,this.timer.boundingBox.y,this.timer.boundingBox.width,this.timer.boundingBox.height,"#FFFFFF",0)}else{this.tradeBox1.setVisible(!1),this.tradeBox1.setEnabled(!1),this.tradeBox2.setVisible(!1),this.tradeBox2.setEnabled(!1),this.tradeButton1.setVisible(!1),this.tradeButton1.setEnabled(!1),this.tradeButton2.setVisible(!1),this.tradeButton2.setEnabled(!1),this.newTradeButton.setVisible(!1),this.newTradeButton.setEnabled(!1),this.extendTradeButton.setVisible(!1),this.extendTradeButton.setEnabled(!1);g=_("There was an error, please contact a dev with your export code if you are able to.\nThis error should resolve itself on the next trade.");fillTextWrap(this.context,g,this.bodyContainer.boundingBox.x,this.bodyContainer.boundingBox.y+.3*this.boundingBox.height,this.bodyContainer.boundingBox.width,"center");var a=this.trades[0][TRADE_INDEX_DURATION],x=this.trades[0][TRADE_INDEX_START_TIME];(isNaN(a)||isNaN(x))&&(a=this.trades[1][TRADE_INDEX_DURATION],x=this.trades[1][TRADE_INDEX_START_TIME]);B=a-(currentTime()/1e3-x);renderProgressBar(this.context,_("Time Remaining: {0}",formattedCountDown(B)),darkdot,darkdot,.2*this.boundingBox.width,this.bodyContainer.boundingBox.y+this.bodyContainer.boundingBox.height-.16*this.boundingBox.height,.6*this.boundingBox.width,.08*this.boundingBox.height,"#FFFFFF",0)}else{this.boundingBox.width=this.defaultWidth,this.boundingBox.height=this.defaultHeight;var u=Math.min(14,.032*this.boundingBox.height)+"px Verdana";this.context.font=u,this.tradeBox1.setVisible(!1),this.tradeBox1.setEnabled(!1),this.tradeBox2.setVisible(!1),this.tradeBox2.setEnabled(!1),this.tradeButton1.setVisible(!1),this.tradeButton1.setEnabled(!1),this.tradeButton2.setVisible(!1),this.tradeButton2.setEnabled(!1),this.extendTradeButton.setVisible(!1),this.extendTradeButton.setEnabled(!1),this.newTradeButton.setVisible(!0),this.newTradeButton.setEnabled(!0);var g=_("There's nobody here...")+" <br> "+_("Upgrade your trading post to decrease time between trades.");fillTextWrap(this.context,_(g),this.bodyContainer.boundingBox.x,this.bodyContainer.boundingBox.y+.3*this.boundingBox.height,this.bodyContainer.boundingBox.width,"center");this.newTradeButton.boundingBox.x=this.boundingBox.width/2-this.newTradeButton.boundingBox.width/2,this.newTradeButton.boundingBox.y=this.boundingBox.height/2-this.newTradeButton.boundingBox.height/2;var B=getNextTradeTimeForWorld(this.worldIndex)-playtime;renderProgressBar(this.context,_("New Trade In {0}",formattedCountDown(B)),darkdot,darkdot,.2*this.boundingBox.width,this.bodyContainer.boundingBox.y+this.bodyContainer.boundingBox.height-.16*this.boundingBox.height,.6*this.boundingBox.width,.08*this.boundingBox.height,"#FFFFFF",0)}this.context.restore()}createTradeBox(t){var i=Math.min(55,.091*this.boundingBox.height),e=i,o=this.boundingBox.width,n=this.boundingBox.height,d=.14*o,h=.12*n,s=new Hitbox({x:-300,y:-300,width:.5*this.boundingBox.width,height:Math.min(100,.17*this.boundingBox.height)},{},"");s.render=function(){var i=this.getContext(),o=this.getRootLayer();if(0!=o.trades.length&&isTradeAvailable(o.trades[0])){var n=o.trades[t],s=generateTradeOfferStrings(n),r=this.getRelativeCoordinates(0,0,o),a=r.x,x=r.y;i.save(),i.fillStyle="#000000",i.globalAlpha=.4,i.fillRect(a,x,this.boundingBox.width,this.boundingBox.height),i.globalAlpha=1,i.fillStyle="#FFFFFF",i.strokeStyle="#FFFFFF",i.textBaseline="top";var u=Math.min(14,.032*o.boundingBox.height);i.font=u+"px Verdana";var g=fillTextWrap(i,_("YOU PAY:"),a,x+5,this.boundingBox.width/2-d/2-10,"center",.25),B=fillTextWrap(i,s.paymentString,a,g.y2+e+10,this.boundingBox.width/2-d/2-10,"center",.25),b=fillTextWrap(i,_("YOU RECEIVE:"),a+3*this.boundingBox.width/4+d/4-(this.boundingBox.width/2-d/2-10)/2,x+5,this.boundingBox.width/2-d/2-10,"center",.25),l=fillTextWrap(i,s.rewardString,a+3*this.boundingBox.width/4+d/4-(this.boundingBox.width/2-d/2-10)/2,b.y2+e+10,this.boundingBox.width/2-d/2-10,"center",.25);B.y2-x>this.boundingBox.height&&(this.boundingBox.height=B.y2-x+10),l.y2-x>this.boundingBox.height&&(this.boundingBox.height=l.y2-x+10),i.lineWidth=3,i.beginPath(),i.moveTo(a+this.boundingBox.width/2-d/2,x+this.boundingBox.height/2+h/4),i.lineTo(a+this.boundingBox.width/2+d/12,x+this.boundingBox.height/2+h/4),i.lineTo(a+this.boundingBox.width/2+d/12,x+this.boundingBox.height/2+h/2),i.lineTo(a+this.boundingBox.width/2+d/2,x+this.boundingBox.height/2),i.lineTo(a+this.boundingBox.width/2+d/12,x+this.boundingBox.height/2-h/2),i.lineTo(a+this.boundingBox.width/2+d/12,x+this.boundingBox.height/2-h/4),i.lineTo(a+this.boundingBox.width/2-d/2,x+this.boundingBox.height/2-h/4),i.closePath(),i.fill(),i.restore(),this.renderChildren()}};var r=new Hitbox({x:s.boundingBox.width/4-d/8-i/2,y:0,width:i,height:s.boundingBox.height},{},"");s.addHitbox(r),r.render=function(){var i=this.getContext(),e=this.getRootLayer(),o=e.trades[t],n=this.getRelativeCoordinates(0,0,e),d=n.x,h=n.y;i.save(),drawTradeIcon(i,o[TRADE_INDEX_PAYMENT_TYPE],o[TRADE_INDEX_PAYMENT_SUBTYPE],d,h,this.boundingBox.width,this.boundingBox.height),i.restore()};var a=new Hitbox({x:3*s.boundingBox.width/4+5*d/8,y:0,width:i,height:s.boundingBox.height},{onmouseenter:function(){var i=this.getGlobalCoordinates(0,this.boundingBox.height),e=this.getRootLayer().trades[t];switch(e[TRADE_INDEX_REWARD_TYPE]){case TRADE_TYPE_BUFF:6!=e[TRADE_INDEX_REWARD_SUBTYPE]?buffs.showInactiveBuffTooltip(e[TRADE_INDEX_REWARD_SUBTYPE],i.x,i.y,50,10):buffs.showInactiveBuffTooltip(e[TRADE_INDEX_REWARD_SUBTYPE],i.x,i.y,50,.5);break;case TRADE_TYPE_RELIC:showTooltipForUnequippedRelic(e[TRADE_INDEX_REWARD_SUBTYPE],i.x,i.y);break;case TRADE_TYPE_BLUEPRINT:var o=getDrillEquipByBlueprintId(e[TRADE_INDEX_REWARD_SUBTYPE]),n=new DrillCraftingItem(o.id).getDescription();showTooltip(o.translatedName+" (Lvl "+o.level+")",n,i.x,i.y)}},onmouseexit:function(){hideTooltip()}},"");return s.addHitbox(a),a.render=function(){var i=this.getContext(),e=this.getRootLayer(),o=e.trades[t],n=this.getRelativeCoordinates(0,0,e),d=n.x,h=n.y;i.save(),drawTradeIcon(i,o[TRADE_INDEX_REWARD_TYPE],o[TRADE_INDEX_REWARD_SUBTYPE],d,h,this.boundingBox.width,this.boundingBox.height),i.restore()},s}}